<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Linux åº”æ€¥å“åº”æŠ¥å‘ŠæŸ¥çœ‹å™¨ (å¢å¼ºç‰ˆ)</title>
<style>
body { 
  font-family: "Microsoft YaHei", Arial, sans-serif; 
  background: #f5f5f5; 
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  color: white;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header h1 {
  margin: 0 0 15px 0;
  font-size: 2.2em;
}

.header .subtitle {
  font-size: 1.1em;
  opacity: 0.9;
}

.main-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.content-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.sidebar {
  width: 350px;
  background: #fff;
  border-left: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
}

.alert-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.alert { 
  padding: 15px; 
  margin-bottom: 10px; 
  border-radius: 5px;
}

.alert-high { 
  background: #ffebee; 
  color: #c62828; 
  border-left: 5px solid #c62828; 
}

.alert-medium { 
  background: #fff3e0; 
  color: #ef6c00; 
  border-left: 5px solid #ef6c00; 
}

.alert-low { 
  background: #e3f2fd; 
  color: #1565c0; 
  border-left: 5px solid #1565c0; 
}

.alert-link { 
  cursor: pointer; 
  color: inherit; 
  text-decoration: underline; 
}

.alert-count { 
  background: #fff; 
  padding: 2px 8px; 
  border-radius: 10px; 
  margin-left: 10px; 
  font-size: 12px; 
}

.search-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

#searchInput {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  min-width: 200px;
}

.search-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.search-nav button {
  padding: 8px 15px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.search-nav button:hover {
  background: #1976D2;
}

.search-nav button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.tabs {
  overflow: hidden;
  background: #333;
  border-radius: 5px;
  margin-bottom: 10px;
  display: flex;
  flex-wrap: wrap;
}

.tabs button {
  background: #333;
  color: #fff;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 14px;
  flex: 1;
  min-width: 120px;
}

.tabs button:hover {
  background: #ddd;
  color: black;
}

.tabs button.active {
  background: #2196F3;
  color: white;
}

.tabcontent {
  display: none;
  padding: 20px;
  background: #fff;
  border-radius: 5px;
  margin-top: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tabcontent pre {
  background: #222;
  color: #eee;
  padding: 15px;
  border-radius: 5px;
  overflow-x: auto;
  margin: 0;
  font-size: 14px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.tabcontent details {
  margin-bottom: 15px;
  border: 1px solid #e0e0e0;
  border-radius: 5px;
}

.tabcontent summary {
  cursor: pointer;
  font-weight: bold;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 5px 5px 0 0;
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.3s;
}

.tabcontent summary:hover {
  background: #e9ecef;
}

.tabcontent details[open] summary {
  background: #007bff;
  color: white;
}

.mark {
  background: yellow;
  color: red;
  font-weight: bold;
}

.mark.current {
  background: #ff4444;
  color: white;
}

#fileInput {
  margin: 10px 0;
}

.alert-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.alert-badge {
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
}

.alert-badge.high {
  background: #ffebee;
  color: #c62828;
}

.alert-badge.medium {
  background: #fff3e0;
  color: #ef6c00;
}

.alert-badge.low {
  background: #e3f2fd;
  color: #1565c0;
}

.alert-badge .count {
  background: rgba(255,255,255,0.8);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
}

.collapse-button {
  padding: 5px 10px;
  background: none;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  margin-left: auto;
}

.collapse-button:hover {
  background: #f0f0f0;
}

/* ç»Ÿè®¡é¢æ¿æ ·å¼ */
.stats-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.stat-item {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9em;
  opacity: 0.9;
}

.risk-level {
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  margin: 10px 0;
}

.risk-high { background: #ff4757; color: white; }
.risk-medium { background: #ffa502; color: white; }
.risk-low { background: #3742fa; color: white; }
.risk-normal { background: #2ed573; color: white; }

/* å»ºè®®é¢æ¿æ ·å¼ */
.recommendations-panel {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  border-left: 5px solid #28a745;
}

.recommendation-item {
  background: white;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.recommendation-level {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  margin-right: 10px;
}

.level-high { background: #ff4757; color: white; }
.level-medium { background: #ffa502; color: white; }
.level-low { background: #3742fa; color: white; }
.level-info { background: #2ed573; color: white; }

@keyframes highlight-pulse {
  0% { background: #ff4444; }
  50% { background: #ff8888; }
  100% { background: #ff4444; }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .main-container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    max-height: 300px;
  }
  
  .tabs {
    flex-direction: column;
  }
  
  .tabs button {
    flex: none;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
}

</style>
<script>
const TAB_TITLES = {
  summary: "ğŸ“Š ç»Ÿè®¡åˆ†ææ€»è§ˆ",
  backdoor: "ğŸ” ç³»ç»Ÿåé—¨æ’æŸ¥",
  user: "ğŸ‘¥ ç”¨æˆ·ä¸ç™»å½•æ£€æŸ¥",
  log: "ğŸ“‹ æ—¥å¿—åˆ†æ",
  network: "ğŸŒ ç½‘ç»œæ£€æŸ¥",
  process: "âš™ï¸ è¿›ç¨‹æ£€æŸ¥",
  filesystem: "ğŸ“ æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥",
  package: "ğŸ“¦ è½¯ä»¶åŒ…æ£€æŸ¥",
  persistence: "ğŸ”„ æŒä¹…åŒ–æ£€æŸ¥",
  integrity: "ğŸ›¡ï¸ ç³»ç»Ÿå®Œæ•´æ€§",
  malware: "ğŸ¦  æ¶æ„è¿›ç¨‹ä¸ææƒç‚¹"
};

const SUB_TAB_TITLES = {
  summary: ["ç³»ç»Ÿæ¦‚è§ˆ", "é£é™©è¯„ä¼°", "æ™ºèƒ½å»ºè®®", "æ£€æŸ¥æ¸…å•", "ä¸“ä¸šæ€»ç»“"],
  backdoor: ["UIDä¸º0çš„érootç”¨æˆ·", "å¯ç–‘ç³»ç»Ÿé…ç½®", "å¼‚å¸¸ç³»ç»Ÿæ–‡ä»¶"],
  user: ["å½“å‰ç”¨æˆ·", "æ‰€æœ‰ç”¨æˆ·", "æœ€è¿‘ç™»å½•è®°å½•", "ç™»å½•å¤±è´¥è®°å½•"],
  log: ["ç³»ç»Ÿæ—¥å¿—é”™è¯¯", "å®‰å…¨æ—¥å¿—é”™è¯¯"],
  network: ["ç›‘å¬ç«¯å£", "æ´»åŠ¨è¿æ¥", "ç½‘ç»œé…ç½®", "è·¯ç”±è¡¨", "å¯ç–‘è¿æ¥"],
  process: ["é«˜CPUå ç”¨è¿›ç¨‹", "å¯ç–‘è„šæœ¬è¿›ç¨‹"],
  filesystem: ["SUIDæ–‡ä»¶", "æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶"],
  package: ["å·²å®‰è£…çš„è½¯ä»¶åŒ…"],
  persistence: ["è‡ªå¯åŠ¨æœåŠ¡", "è®¡åˆ’ä»»åŠ¡", "SSHå…¬é’¥", "å¯åŠ¨é¡¹é…ç½®"],
  integrity: ["å…³é”®äºŒè¿›åˆ¶æ–‡ä»¶æ ¡éªŒ", "ç³»ç»Ÿæ–‡ä»¶å®Œæ•´æ€§"],
  malware: ["å¯ç–‘è¿›ç¨‹", "å¯ç–‘ææƒç‚¹", "éšè—æ–‡ä»¶"]
};

let gTabs = Object.keys(TAB_TITLES);
let gContent = "";
let currentSearchIndex = -1;
let searchResults = [];
let analysisData = null;

// å‘Šè­¦ç»“æœå­˜å‚¨
let alertResults = {
  high: [],
  medium: [],
  low: []
};

// ç»Ÿè®¡æ•°æ®å­˜å‚¨
let systemStats = {
  total_users: 0,
  uid0_users: 0,
  listening_ports: 0,
  suspicious_processes: 0,
  suid_files: 0,
  recent_files: 0,
  failed_logins: 0,
  cron_jobs: 0,
  risk_score: 0,
  risk_level: 'NORMAL'
};

function parseTextReport(text) {
  const sections = text.split("##########################################");
  const data = {};
  let currentSection = null;
  
  for (const section of sections) {
    if (!section.trim()) continue;
    
    const moduleMatch = section.match(/æ¨¡å—: (.*?)\n/);
    if (!moduleMatch) continue;
    
    const moduleTitle = moduleMatch[1];
    const moduleKey = Object.keys(TAB_TITLES).find(key => TAB_TITLES[key].includes(moduleTitle) || TAB_TITLES[key] === moduleTitle);
    if (!moduleKey) continue;
    
    const subSections = section.split("------------------------------------------");
    data[moduleKey] = {};
    
    for (let i = 1; i < subSections.length; i += 2) {
      const titleMatch = subSections[i].match(/å­é¡¹: (.*?)\n/);
      if (!titleMatch) continue;
      const title = titleMatch[1];
      const content = subSections[i + 1] ? subSections[i + 1].trim() : "";
      data[moduleKey][title] = content;
    }
  }
  
  return data;
}

// ç”Ÿæˆç»Ÿè®¡åˆ†æ
function generateStatistics(data) {
  const stats = {
    system_overview: {},
    security_summary: {},
    risk_assessment: {},
    recommendations: []
  };
  
  // é‡ç½®ç»Ÿè®¡æ•°æ®
  systemStats = {
    total_users: 0,
    uid0_users: 0,
    listening_ports: 0,
    suspicious_processes: 0,
    suid_files: 0,
    recent_files: 0,
    failed_logins: 0,
    cron_jobs: 0,
    risk_score: 0,
    risk_level: 'NORMAL'
  };
  
  // ç”¨æˆ·ç»Ÿè®¡
  if (data.user && data.user['æ‰€æœ‰ç”¨æˆ·']) {
    const users = data.user['æ‰€æœ‰ç”¨æˆ·'].split('\n').filter(u => u.trim());
    systemStats.total_users = users.length;
  }
  
  if (data.backdoor && data.backdoor['UIDä¸º0çš„érootç”¨æˆ·']) {
    const uid0Content = data.backdoor['UIDä¸º0çš„érootç”¨æˆ·'];
    systemStats.uid0_users = (uid0Content.match(/å¯ç–‘UID 0ç”¨æˆ·/g) || []).length;
  }
  
  // ç½‘ç»œç»Ÿè®¡
  if (data.network && data.network['ç›‘å¬ç«¯å£']) {
    const ports = data.network['ç›‘å¬ç«¯å£'];
    systemStats.listening_ports = (ports.match(/LISTEN|:/g) || []).length;
  }
  
  // è¿›ç¨‹ç»Ÿè®¡
  if (data.process && data.process['å¯ç–‘è„šæœ¬è¿›ç¨‹']) {
    const processes = data.process['å¯ç–‘è„šæœ¬è¿›ç¨‹'].split('\n').filter(p => p.trim());
    systemStats.suspicious_processes = processes.length;
  }
  
  // æ–‡ä»¶ç³»ç»Ÿç»Ÿè®¡
  if (data.filesystem && data.filesystem['SUIDæ–‡ä»¶']) {
    const suidFiles = data.filesystem['SUIDæ–‡ä»¶'];
    systemStats.suid_files = (suidFiles.match(/-rws/g) || []).length;
  }
  
  if (data.filesystem && data.filesystem['æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶']) {
    const recentFiles = data.filesystem['æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶'].split('\n').filter(f => f.trim());
    systemStats.recent_files = recentFiles.length;
  }
  
  // ç™»å½•å¤±è´¥ç»Ÿè®¡
  if (data.user && data.user['ç™»å½•å¤±è´¥è®°å½•']) {
    const failedLogins = data.user['ç™»å½•å¤±è´¥è®°å½•'];
    systemStats.failed_logins = (failedLogins.match(/Failed password/g) || []).length;
  }
  
  // è®¡åˆ’ä»»åŠ¡ç»Ÿè®¡
  if (data.persistence && data.persistence['è®¡åˆ’ä»»åŠ¡']) {
    const cronJobs = data.persistence['è®¡åˆ’ä»»åŠ¡'];
    systemStats.cron_jobs = (cronJobs.match(/crontab|cron|\*/g) || []).length;
  }
  
  // é£é™©è¯„åˆ†è®¡ç®—
  let riskScore = 0;
  const recommendations = [];
  
  if (systemStats.uid0_users > 0) {
    riskScore += 50;
    recommendations.push({
      level: 'high',
      title: 'å‘ç°å¼‚å¸¸é«˜æƒé™ç”¨æˆ·',
      description: `å‘ç° ${systemStats.uid0_users} ä¸ªérootçš„UIDä¸º0ç”¨æˆ·ï¼Œè¿™å¯èƒ½æ˜¯å®‰å…¨å¨èƒã€‚`,
      action: 'å»ºè®®ç«‹å³ä¸è¿ç»´å’Œå¼€å‘äººå‘˜ç¡®è®¤è¿™äº›ç”¨æˆ·çš„åˆæ³•æ€§ï¼Œå¦‚æ— æ³•ç¡®è®¤åº”ç«‹å³ç¦ç”¨ã€‚'
    });
  } else {
    recommendations.push({
      level: 'info',
      title: 'ç”¨æˆ·æƒé™æ£€æŸ¥æ­£å¸¸',
      description: `ç³»ç»Ÿå…±æœ‰ ${systemStats.total_users} ä¸ªç”¨æˆ·è´¦æˆ·ï¼Œé™¤rootå¤–æœªå‘ç°å…¶ä»–UIDä¸º0çš„é«˜æƒé™ç”¨æˆ·ï¼Œè¿™æ˜¯è‰¯å¥½çš„å®‰å…¨å®è·µã€‚`,
      action: 'å»ºè®®å®šæœŸå®¡æŸ¥ç”¨æˆ·è´¦æˆ·ï¼Œç¡®ä¿æƒé™åˆ†é…åˆç†ã€‚'
    });
  }
  
  if (systemStats.suspicious_processes > 10) {
    riskScore += 30;
    recommendations.push({
      level: 'medium',
      title: 'å¯ç–‘è¿›ç¨‹æ•°é‡å¼‚å¸¸',
      description: `å‘ç° ${systemStats.suspicious_processes} ä¸ªå¯ç–‘è„šæœ¬è¿›ç¨‹ï¼Œæ•°é‡è¾ƒå¤šã€‚`,
      action: 'å»ºè®®æ£€æŸ¥è¿™äº›è¿›ç¨‹çš„åˆæ³•æ€§ï¼Œç¡®è®¤å…¶ä¸šåŠ¡å¿…è¦æ€§ã€‚'
    });
  } else if (systemStats.suspicious_processes > 0) {
    recommendations.push({
      level: 'low',
      title: 'å‘ç°å°‘é‡å¯ç–‘è¿›ç¨‹',
      description: `å‘ç° ${systemStats.suspicious_processes} ä¸ªå¯ç–‘è„šæœ¬è¿›ç¨‹ã€‚`,
      action: 'å»ºè®®ç¡®è®¤è¿™äº›è¿›ç¨‹çš„ä¸šåŠ¡å¿…è¦æ€§ã€‚'
    });
  }
  
  if (systemStats.suid_files > 100) {
    riskScore += 20;
    recommendations.push({
      level: 'medium',
      title: 'SUIDæ–‡ä»¶æ•°é‡å¼‚å¸¸',
      description: `å‘ç° ${systemStats.suid_files} ä¸ªSUIDæ–‡ä»¶ï¼Œæ•°é‡è¾ƒå¤šã€‚`,
      action: 'å»ºè®®å®¡æŸ¥SUIDæ–‡ä»¶åˆ—è¡¨ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨å¼‚å¸¸çš„ææƒæ–‡ä»¶ã€‚'
    });
  }
  
  if (systemStats.failed_logins > 50) {
    riskScore += 25;
    recommendations.push({
      level: 'medium',
      title: 'ç™»å½•å¤±è´¥æ¬¡æ•°å¼‚å¸¸',
      description: `ç™»å½•å¤±è´¥æ¬¡æ•°(${systemStats.failed_logins})è¾ƒå¤šï¼Œå¯èƒ½å­˜åœ¨æš´åŠ›ç ´è§£æ”»å‡»ã€‚`,
      action: 'å»ºè®®æ£€æŸ¥ç™»å½•æ—¥å¿—ï¼ŒåŠ å¼ºå¯†ç ç­–ç•¥å’Œè®¿é—®æ§åˆ¶ã€‚'
    });
  }
  
  if (systemStats.listening_ports > 20) {
    riskScore += 15;
    recommendations.push({
      level: 'low',
      title: 'ç›‘å¬ç«¯å£æ•°é‡è¾ƒå¤š',
      description: `ç›‘å¬ç«¯å£æ•°é‡(${systemStats.listening_ports})è¾ƒå¤šã€‚`,
      action: 'å»ºè®®å…³é—­ä¸å¿…è¦çš„æœåŠ¡ä»¥å‡å°‘æ”»å‡»é¢ã€‚'
    });
  }
  
  // ç¡®å®šé£é™©ç­‰çº§
  if (riskScore >= 80) {
    systemStats.risk_level = 'HIGH';
  } else if (riskScore >= 50) {
    systemStats.risk_level = 'MEDIUM';
  } else if (riskScore >= 20) {
    systemStats.risk_level = 'LOW';
  } else {
    systemStats.risk_level = 'NORMAL';
  }
  
  systemStats.risk_score = riskScore;
  
  return {
    statistics: systemStats,
    recommendations: recommendations
  };
}

// ç”Ÿæˆç»Ÿè®¡æ€»è§ˆå†…å®¹
function generateSummaryContent(data) {
  const analysis = generateStatistics(data);
  const stats = analysis.statistics;
  const recommendations = analysis.recommendations;
  
  const summaryData = {
    'ç³»ç»Ÿæ¦‚è§ˆ': `
=== ç³»ç»ŸåŸºæœ¬ä¿¡æ¯ ===
æ£€æŸ¥æ—¶é—´: ${new Date().toLocaleString()}
æ€»ç”¨æˆ·æ•°: ${stats.total_users}
UIDä¸º0çš„érootç”¨æˆ·: ${stats.uid0_users}
ç›‘å¬ç«¯å£æ•°: ${stats.listening_ports}
å¯ç–‘è¿›ç¨‹æ•°: ${stats.suspicious_processes}
SUIDæ–‡ä»¶æ•°: ${stats.suid_files}
æœ€è¿‘ä¿®æ”¹æ–‡ä»¶æ•°: ${stats.recent_files}
ç™»å½•å¤±è´¥æ¬¡æ•°: ${stats.failed_logins}
è®¡åˆ’ä»»åŠ¡æ•°: ${stats.cron_jobs}

=== é£é™©è¯„ä¼° ===
é£é™©è¯„åˆ†: ${stats.risk_score}
é£é™©ç­‰çº§: ${stats.risk_level}
    `,
    
    'é£é™©è¯„ä¼°': `
=== é£é™©ç­‰çº§è¯´æ˜ ===
NORMAL (0-19åˆ†): ç³»ç»Ÿå®‰å…¨çŠ¶å†µè‰¯å¥½
LOW (20-49åˆ†): å­˜åœ¨è½»å¾®å®‰å…¨é£é™©
MEDIUM (50-79åˆ†): å­˜åœ¨ä¸­ç­‰å®‰å…¨é£é™©ï¼Œéœ€è¦å…³æ³¨
HIGH (80+åˆ†): å­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©ï¼Œéœ€è¦ç«‹å³å¤„ç†

=== å½“å‰é£é™©åˆ†æ ===
æ€»è¯„åˆ†: ${stats.risk_score} åˆ†
é£é™©ç­‰çº§: ${stats.risk_level}

è¯„åˆ†æ„æˆ:
- UIDä¸º0å¼‚å¸¸ç”¨æˆ·: ${stats.uid0_users > 0 ? '+50åˆ† (é«˜å±)' : '0åˆ† (æ­£å¸¸)'}
- å¯ç–‘è¿›ç¨‹è¿‡å¤š: ${stats.suspicious_processes > 10 ? '+30åˆ† (ä¸­å±)' : stats.suspicious_processes > 0 ? '+10åˆ† (ä½å±)' : '0åˆ† (æ­£å¸¸)'}
- SUIDæ–‡ä»¶å¼‚å¸¸: ${stats.suid_files > 100 ? '+20åˆ† (ä¸­å±)' : '0åˆ† (æ­£å¸¸)'}
- ç™»å½•å¤±è´¥è¿‡å¤š: ${stats.failed_logins > 50 ? '+25åˆ† (ä¸­å±)' : '0åˆ† (æ­£å¸¸)'}
- ç›‘å¬ç«¯å£è¿‡å¤š: ${stats.listening_ports > 20 ? '+15åˆ† (ä½å±)' : '0åˆ† (æ­£å¸¸)'}
    `,
    
    'æ™ºèƒ½å»ºè®®': recommendations.map(rec => 
      `[${rec.level.toUpperCase()}] ${rec.title}\n${rec.description}\nå¤„ç½®å»ºè®®: ${rec.action}`
    ).join('\n\n'),
    
    'æ£€æŸ¥æ¸…å•': generateProfessionalSummary(data, stats),
    
    'ä¸“ä¸šæ€»ç»“': generateIncidentResponseSummary(data, stats)
  };
  
  return summaryData;
}

// ç”Ÿæˆä¸“ä¸šæ£€æŸ¥æ¸…å•
function generateProfessionalSummary(data, stats) {
  return `
=== åº”æ€¥å“åº”æ£€æŸ¥æ¸…å• (åŸºäºNIST SP 800-61æ¡†æ¶) ===

ã€å‡†å¤‡é˜¶æ®µ - Preparationã€‘
â–¡ 1. ç¡®è®¤åº”æ€¥å“åº”å›¢é˜Ÿè”ç³»æ–¹å¼å’ŒèŒè´£åˆ†å·¥
â–¡ 2. éªŒè¯å¤‡ä»½ç³»ç»Ÿå’Œæ¢å¤ç¨‹åºçš„å¯ç”¨æ€§
â–¡ 3. ç¡®ä¿æ—¥å¿—è®°å½•å’Œç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

ã€æ£€æµ‹ä¸åˆ†æé˜¶æ®µ - Detection & Analysisã€‘
â–¡ 4. ç¡®è®¤æ‰€æœ‰UIDä¸º0çš„ç”¨æˆ·åˆæ³•æ€§ ${stats.uid0_users > 0 ? 'âš ï¸ å‘ç°å¼‚å¸¸' : 'âœ… æ­£å¸¸'}
â–¡ 5. åˆ†æå¯ç–‘è¿›ç¨‹çš„ä¸šåŠ¡å¿…è¦æ€§ ${stats.suspicious_processes > 10 ? 'âš ï¸ æ•°é‡å¼‚å¸¸' : 'âœ… æ­£å¸¸èŒƒå›´'}
â–¡ 6. å®¡æŸ¥SUIDæ–‡ä»¶æ˜¯å¦å­˜åœ¨å¼‚å¸¸ææƒç‚¹
â–¡ 7. åˆ†æç™»å½•å¤±è´¥æ—¥å¿—ï¼Œè¯†åˆ«æ½œåœ¨çš„æš´åŠ›ç ´è§£æ”»å‡» ${stats.failed_logins > 50 ? 'âš ï¸ å¤±è´¥æ¬¡æ•°è¿‡å¤š' : 'âœ… æ­£å¸¸'}
â–¡ 8. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œç›‘å¬ç«¯å£çš„åˆæ³•æ€§ ${stats.listening_ports > 20 ? 'âš ï¸ ç«¯å£è¾ƒå¤š' : 'âœ… æ­£å¸¸'}

ã€éåˆ¶é˜¶æ®µ - Containmentã€‘
â–¡ 9. éš”ç¦»å¯ç–‘ç³»ç»Ÿå’Œç½‘ç»œè¿æ¥
â–¡ 10. ä¿æŠ¤å…³é”®æ•°æ®å’Œç³»ç»Ÿèµ„æº
â–¡ 11. æ”¶é›†å’Œä¿å­˜æ•°å­—è¯æ®

ã€æ ¹é™¤é˜¶æ®µ - Eradicationã€‘
â–¡ 12. æ¸…é™¤æ¶æ„è½¯ä»¶å’Œåé—¨ç¨‹åº
â–¡ 13. ä¿®å¤ç³»ç»Ÿæ¼æ´å’Œå®‰å…¨é…ç½®
â–¡ 14. æ›´æ–°ç³»ç»Ÿè¡¥ä¸å’Œå®‰å…¨ç­–ç•¥

ã€æ¢å¤é˜¶æ®µ - Recoveryã€‘
â–¡ 15. éªŒè¯ç³»ç»Ÿå®Œæ•´æ€§å’ŒåŠŸèƒ½æ­£å¸¸
â–¡ 16. æ¢å¤ä¸šåŠ¡æœåŠ¡å’Œæ•°æ®è®¿é—®
â–¡ 17. åŠ å¼ºç›‘æ§å’Œæ—¥å¿—è®°å½•

ã€äº‹åæ´»åŠ¨ - Post-Incident Activityã€‘
â–¡ 18. ç¼–å†™è¯¦ç»†çš„äº‹ä»¶æŠ¥å‘Š
â–¡ 19. æ€»ç»“ç»éªŒæ•™è®­å’Œæ”¹è¿›å»ºè®®
â–¡ 20. æ›´æ–°åº”æ€¥å“åº”ç¨‹åºå’Œé¢„æ¡ˆ

=== ä¼˜å…ˆçº§å¤„ç†å»ºè®® ===
${stats.uid0_users > 0 ? 'ğŸ”´ ç´§æ€¥ (P0): ç«‹å³å¤„ç†UIDä¸º0å¼‚å¸¸ç”¨æˆ·ï¼Œå¯èƒ½å­˜åœ¨æƒé™æå‡å¨èƒ' : ''}
${stats.risk_score >= 80 ? 'ğŸ”´ é«˜å± (P1): ç³»ç»Ÿå­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©ï¼Œéœ€è¦ç«‹å³å“åº”' : ''}
${stats.risk_score >= 50 && stats.risk_score < 80 ? 'ğŸŸ¡ ä¸­å± (P2): å­˜åœ¨å®‰å…¨éšæ‚£ï¼Œå»ºè®®24å°æ—¶å†…å¤„ç†' : ''}
${stats.risk_score >= 20 && stats.risk_score < 50 ? 'ğŸŸ¢ ä½å± (P3): ä¼˜åŒ–å®‰å…¨é…ç½®ï¼Œå»ºè®®72å°æ—¶å†…å¤„ç†' : ''}
${stats.risk_score < 20 ? 'âœ… æ­£å¸¸ (P4): ç³»ç»Ÿå®‰å…¨çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®å®šæœŸæ£€æŸ¥ç»´æŠ¤' : ''}
  `;
}

// ç”Ÿæˆä¸“ä¸šçš„äº‹ä»¶å“åº”æ€»ç»“
function generateIncidentResponseSummary(data, stats) {
  const currentTime = new Date().toLocaleString();
  
  // åˆ†æå·²ç¡®è®¤å®‰å…¨çš„é¡¹ç›®
  const secureItems = [];
  if (stats.uid0_users === 0) secureItems.push('ç”¨æˆ·æƒé™é…ç½®');
  if (stats.failed_logins < 10) secureItems.push('ç™»å½•å®‰å…¨çŠ¶å†µ');
  if (stats.suspicious_processes < 5) secureItems.push('è¿›ç¨‹è¿è¡ŒçŠ¶æ€');
  
  // éœ€è¦ä¸è¿ç»´ç¡®è®¤çš„é¡¹ç›®
  const confirmItems = [];
  if (stats.listening_ports > 10) confirmItems.push(`ç½‘ç»œæœåŠ¡é…ç½®(${stats.listening_ports}ä¸ªç›‘å¬ç«¯å£)`);
  if (stats.cron_jobs > 5) confirmItems.push(`è®¡åˆ’ä»»åŠ¡é…ç½®(${stats.cron_jobs}ä¸ªä»»åŠ¡)`);
  if (stats.suid_files > 50) confirmItems.push(`SUIDæ–‡ä»¶æƒé™(${stats.suid_files}ä¸ªæ–‡ä»¶)`);
  
  // å·²ç¡®è®¤å­˜åœ¨å¨èƒçš„é¡¹ç›®
  const threatItems = [];
  if (stats.uid0_users > 0) threatItems.push(`å¼‚å¸¸é«˜æƒé™ç”¨æˆ·(${stats.uid0_users}ä¸ª)`);
  if (stats.failed_logins > 50) threatItems.push(`æš´åŠ›ç ´è§£æ”»å‡»è¿¹è±¡(${stats.failed_logins}æ¬¡å¤±è´¥)`);
  
  // æœªå®Œæˆæ£€æŸ¥çš„é¡¹ç›®
  const pendingItems = [
    'æ·±åº¦æ¶æ„è½¯ä»¶æ‰«æ',
    'ç½‘ç»œæµé‡å¼‚å¸¸åˆ†æ',
    'æ–‡ä»¶å®Œæ•´æ€§æ·±åº¦æ ¡éªŒ',
    'å†…å­˜è½¬å‚¨åˆ†æ',
    'ç³»ç»Ÿè°ƒç”¨å®¡è®¡'
  ];
  
  return `
=== ç½‘ç»œå®‰å…¨äº‹ä»¶å“åº”æ€»ç»“æŠ¥å‘Š ===
æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${currentTime}
åˆ†æå¸ˆ: è‡ªåŠ¨åŒ–åº”æ€¥å“åº”ç³»ç»Ÿ
äº‹ä»¶ç­‰çº§: ${stats.risk_level} (è¯„åˆ†: ${stats.risk_score}/100)

ã€æ‰§è¡Œæ‘˜è¦ - Executive Summaryã€‘
æœ¬æ¬¡åº”æ€¥å“åº”æ£€æŸ¥åŸºäºNIST SP 800-61ç½‘ç»œå®‰å…¨äº‹ä»¶å¤„ç†æŒ‡å—æ‰§è¡Œï¼Œé‡‡ç”¨æ ‡å‡†åŒ–çš„æ£€æµ‹ã€åˆ†æã€éåˆ¶ã€æ ¹é™¤ã€æ¢å¤æµç¨‹ã€‚é€šè¿‡è‡ªåŠ¨åŒ–å·¥å…·å¯¹ç›®æ ‡ç³»ç»Ÿè¿›è¡Œäº†å…¨é¢çš„å®‰å…¨æ€åŠ¿è¯„ä¼°ã€‚

ã€å·²ç¡®è®¤å®‰å…¨çš„æ£€æŸ¥é¡¹ç›® - Verified Secure Itemsã€‘
${secureItems.length > 0 ? secureItems.map(item => `âœ… ${item}: ç»æ£€æŸ¥ç¡®è®¤ç¬¦åˆå®‰å…¨åŸºçº¿è¦æ±‚`).join('\n') : 'âš ï¸ æš‚æ— å®Œå…¨ç¡®è®¤å®‰å…¨çš„é¡¹ç›®ï¼Œå»ºè®®è¿›ä¸€æ­¥æ·±å…¥åˆ†æ'}

ã€éœ€è¦è¿ç»´ç¡®è®¤çš„ä¸šåŠ¡åˆè§„æ€§é¡¹ç›® - Items Requiring Operational Validationã€‘
${confirmItems.length > 0 ? confirmItems.map(item => `ğŸ” ${item}: å»ºè®®ä¸è¿ç»´å›¢é˜Ÿç¡®è®¤ä¸šåŠ¡åˆè§„æ€§å’Œå¿…è¦æ€§`).join('\n') : 'âœ… æ‰€æœ‰é…ç½®é¡¹ç›®å‡åœ¨æ­£å¸¸èŒƒå›´å†…'}

ã€å·²è¯†åˆ«çš„å®‰å…¨å¨èƒ - Confirmed Security Threatsã€‘
${threatItems.length > 0 ? threatItems.map(item => `ğŸš¨ ${item}: å·²ç¡®è®¤å­˜åœ¨å®‰å…¨é£é™©ï¼Œå»ºè®®ç«‹å³é‡‡å–éåˆ¶æªæ–½`).join('\n') : 'âœ… æœªå‘ç°æ˜ç¡®çš„å®‰å…¨å¨èƒæŒ‡æ ‡'}

ã€å¾…æ·±å…¥æ£€æŸ¥çš„é¡¹ç›® - Pending Advanced Analysisã€‘
${pendingItems.map(item => `â³ ${item}: å»ºè®®ä½¿ç”¨ä¸“ä¸šå·¥å…·è¿›è¡Œæ·±åº¦åˆ†æ`).join('\n')}

ã€å»ºè®®åç»­è¡ŒåŠ¨ - Recommended Next Actionsã€‘
1. ã€ç«‹å³è¡ŒåŠ¨ã€‘é’ˆå¯¹å·²è¯†åˆ«å¨èƒæ‰§è¡Œéåˆ¶å’Œæ ¹é™¤æªæ–½
2. ã€24å°æ—¶å†…ã€‘ä¸è¿ç»´å›¢é˜Ÿç¡®è®¤å¯ç–‘é…ç½®çš„ä¸šåŠ¡åˆè§„æ€§
3. ã€72å°æ—¶å†…ã€‘æ‰§è¡Œæ·±åº¦å®‰å…¨æ‰«æå’Œå¨èƒç‹©çŒæ´»åŠ¨
4. ã€ä¸€å‘¨å†…ã€‘æ›´æ–°å®‰å…¨åŸºçº¿å’Œç›‘æ§è§„åˆ™
5. ã€æŒç»­ç›‘æ§ã€‘åŠ å¼ºæ—¥å¿—åˆ†æå’Œå¼‚å¸¸è¡Œä¸ºæ£€æµ‹

ã€åˆè§„æ€§å£°æ˜ - Compliance Statementã€‘
æœ¬æ¬¡æ£€æŸ¥éµå¾ªä»¥ä¸‹å®‰å…¨æ¡†æ¶å’Œæ ‡å‡†:
â€¢ NIST Cybersecurity Framework 2.0
â€¢ NIST SP 800-61 Rev.3 äº‹ä»¶å“åº”æŒ‡å—
â€¢ ISO/IEC 27035 ä¿¡æ¯å®‰å…¨äº‹ä»¶ç®¡ç†
â€¢ SANS äº‹ä»¶å“åº”å…­æ­¥æ³•

ã€å…è´£å£°æ˜ - Disclaimerã€‘
æœ¬æŠ¥å‘ŠåŸºäºè‡ªåŠ¨åŒ–å·¥å…·ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚å»ºè®®ç»“åˆäººå·¥åˆ†æå’Œä¸“ä¸šå®‰å…¨å›¢é˜Ÿçš„åˆ¤æ–­ï¼Œåˆ¶å®šæœ€ç»ˆçš„å®‰å…¨å“åº”ç­–ç•¥ã€‚å¯¹äºå…³é”®ä¸šåŠ¡ç³»ç»Ÿï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šçš„ç½‘ç»œå®‰å…¨æœåŠ¡æä¾›å•†ã€‚

---
æŠ¥å‘Šç¼–å·: IR-${Date.now()}
åˆ†ç±»çº§åˆ«: å†…éƒ¨ä½¿ç”¨
æœ‰æ•ˆæœŸé™: 30å¤©
  `;
}

function openTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  const tablinks = document.getElementsByClassName("tablinks");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}

function findAllMatches(text, searchTerm) {
  if (!searchTerm) return [];
  const regex = new RegExp(searchTerm, 'gi');
  const matches = [];
  let match;
  while ((match = regex.exec(text)) !== null) {
    matches.push({
      index: match.index,
      text: match[0],
      position: matches.length,
      end: match.index + match[0].length
    });
  }
  return matches;
}

function searchTabs() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  if (!input) {
    updateSearchCount(0, -1);
    return;
  }

  searchResults = [];
  currentSearchIndex = -1;
  
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const tabId = tabs[i].id;
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      const preText = pres[j].textContent;
      const matches = findAllMatches(preText, input);
      matches.forEach(match => {
        searchResults.push({
          tabId,
          preIndex: j,
          ...match
        });
      });
    }
  }
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function updateSearchCount(total, current) {
  const countElement = document.getElementById("searchCount");
  if (total === 0) {
    countElement.textContent = "æœªæ‰¾åˆ°åŒ¹é…é¡¹";
    document.getElementById("prevMatch").disabled = true;
    document.getElementById("nextMatch").disabled = true;
  } else {
    countElement.textContent = `${current + 1}/${total}`;
    document.getElementById("prevMatch").disabled = current <= 0;
    document.getElementById("nextMatch").disabled = current >= total - 1;
  }
}

function navigateSearch(direction) {
  if (searchResults.length === 0) return;
  
  currentSearchIndex += direction;
  if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
  if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function highlightCurrentMatch() {
  // æ¸…é™¤æ‰€æœ‰é«˜äº®
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      let html = pres[j].innerHTML.replace(/<span class="mark.*?">(.*?)<\/span>/g, "$1");
      pres[j].innerHTML = html;
    }
  }
  
  if (searchResults.length === 0 || currentSearchIndex === -1) return;
  
  const currentMatch = searchResults[currentSearchIndex];
  
  // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${currentMatch.tabId}')"]`);
  if (tabButton) {
    tabButton.click();
  }
  
  // é«˜äº®æ‰€æœ‰åŒ¹é…é¡¹ï¼Œå½“å‰åŒ¹é…é¡¹ç‰¹æ®Šé«˜äº®
  const searchTerm = document.getElementById("searchInput").value;
  const regex = new RegExp(`(${searchTerm})`, 'gi');
  const targetPre = document.getElementById(currentMatch.tabId)
    .getElementsByTagName("pre")[currentMatch.preIndex];
  
  targetPre.innerHTML = targetPre.textContent.replace(regex, (match, p1, offset) => {
    const isCurrentMatch = offset === currentMatch.index;
    return `<span class="mark${isCurrentMatch ? ' current' : ''}">${match}</span>`;
  });
  
  // æ‰¾åˆ°å½“å‰åŒ¹é…é¡¹çš„å…ƒç´ 
  const currentElement = targetPre.querySelector('.mark.current');
  if (currentElement) {
    // è·å–çˆ¶çº§detailså…ƒç´ 
    const detailsElement = targetPre.closest('details');
    if (detailsElement && !detailsElement.open) {
      detailsElement.open = true;
    }
    
    // è®¡ç®—æ»šåŠ¨ä½ç½®
    const contentContainer = document.querySelector('.content-container');
    const elementRect = currentElement.getBoundingClientRect();
    const containerRect = contentContainer.getBoundingClientRect();
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å›¾ä¸­
    const isInView = (
      elementRect.top >= containerRect.top &&
      elementRect.bottom <= containerRect.bottom
    );
    
    if (!isInView) {
      // è®¡ç®—ç†æƒ³çš„æ»šåŠ¨ä½ç½®ï¼ˆå°†åŒ¹é…é¡¹æ”¾åœ¨å®¹å™¨ä¸­é—´ï¼‰
      const elementTop = elementRect.top + contentContainer.scrollTop - containerRect.top;
      const containerMiddle = containerRect.height / 2;
      const scrollTo = elementTop - containerMiddle + elementRect.height / 2;
      
      // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
      contentContainer.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });
    }
    
    // æ·»åŠ é—ªçƒåŠ¨ç”»ä»¥çªå‡ºæ˜¾ç¤ºå½“å‰åŒ¹é…é¡¹
    currentElement.style.animation = 'none';
    currentElement.offsetHeight; // è§¦å‘é‡ç»˜
    currentElement.style.animation = 'highlight-pulse 1s';
  }
}

// æ·»åŠ è§„åˆ™å¼•æ“APIè°ƒç”¨
async function analyzeReport(data) {
  try {
    // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸåå’Œç«¯å£
    const response = await fetch('/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const results = await response.json();
    alertResults = results;
    displayAlerts();
  } catch (error) {
    console.error('è§„åˆ™åˆ†æå¤±è´¥:', error);
    // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°åˆ†æ
    performLocalAnalysis(data);
  }
}

// æœ¬åœ°åˆ†æåŠŸèƒ½ï¼ˆå½“APIä¸å¯ç”¨æ—¶ï¼‰
function performLocalAnalysis(data) {
  const localResults = {
    high: [],
    medium: [],
    low: []
  };
  
  // æ£€æŸ¥UIDä¸º0çš„ç”¨æˆ·
  if (data.backdoor && data.backdoor['UIDä¸º0çš„érootç”¨æˆ·']) {
    const uid0Content = data.backdoor['UIDä¸º0çš„érootç”¨æˆ·'];
    if (uid0Content.includes('å¯ç–‘UID 0ç”¨æˆ·') || uid0Content.match(/^(?!root)/m)) {
      localResults.high.push({
        rule_id: 'LOCAL_001',
        section: 'backdoor',
        subsection: 'UIDä¸º0çš„érootç”¨æˆ·',
        description: 'å‘ç°å¯ç–‘çš„UIDä¸º0ç”¨æˆ·',
        severity: 'high',
        recommendation: 'ç«‹å³ä¸è¿ç»´å’Œå¼€å‘äººå‘˜ç¡®è®¤è¿™äº›ç”¨æˆ·çš„åˆæ³•æ€§ï¼Œå¦‚æ— æ³•ç¡®è®¤åº”ç«‹å³ç¦ç”¨'
      });
    }
  }
  
  // æ£€æŸ¥å¯ç–‘è¿›ç¨‹
  if (data.process && data.process['å¯ç–‘è„šæœ¬è¿›ç¨‹']) {
    const processes = data.process['å¯ç–‘è„šæœ¬è¿›ç¨‹'].split('\n').filter(p => p.trim());
    if (processes.length > 10) {
      localResults.medium.push({
        rule_id: 'LOCAL_002',
        section: 'process',
        subsection: 'å¯ç–‘è„šæœ¬è¿›ç¨‹',
        description: `å‘ç°${processes.length}ä¸ªå¯ç–‘è„šæœ¬è¿›ç¨‹ï¼Œæ•°é‡å¼‚å¸¸`,
        severity: 'medium',
        recommendation: 'æ£€æŸ¥è¿™äº›è¿›ç¨‹çš„åˆæ³•æ€§ï¼Œç¡®è®¤å…¶ä¸šåŠ¡å¿…è¦æ€§'
      });
    }
  }
  
  // æ£€æŸ¥ç™»å½•å¤±è´¥
  if (data.user && data.user['ç™»å½•å¤±è´¥è®°å½•']) {
    const failedLogins = data.user['ç™»å½•å¤±è´¥è®°å½•'];
    const failCount = (failedLogins.match(/Failed password/g) || []).length;
    if (failCount > 50) {
      localResults.medium.push({
        rule_id: 'LOCAL_003',
        section: 'user',
        subsection: 'ç™»å½•å¤±è´¥è®°å½•',
        description: `ç™»å½•å¤±è´¥æ¬¡æ•°(${failCount})å¼‚å¸¸ï¼Œå¯èƒ½å­˜åœ¨æš´åŠ›ç ´è§£æ”»å‡»`,
        severity: 'medium',
        recommendation: 'æ£€æŸ¥ç™»å½•æ—¥å¿—ï¼ŒåŠ å¼ºå¯†ç ç­–ç•¥å’Œè®¿é—®æ§åˆ¶'
      });
    }
  }
  
  alertResults = localResults;
  displayAlerts();
  
  // æ˜¾ç¤ºæœ¬åœ°åˆ†ææç¤º
  const container = document.getElementById('alertContainer');
  const localNotice = document.createElement('div');
  localNotice.style.cssText = 'background: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px; color: #1565c0;';
  localNotice.innerHTML = 'ğŸ“ å½“å‰ä½¿ç”¨æœ¬åœ°åˆ†ææ¨¡å¼ï¼ŒåŠŸèƒ½æœ‰é™ã€‚å»ºè®®å¯åŠ¨å®Œæ•´çš„è§„åˆ™å¼•æ“æœåŠ¡è·å¾—æ›´å‡†ç¡®çš„åˆ†æç»“æœã€‚';
  container.insertBefore(localNotice, container.firstChild);
}

// ä¿®æ”¹renderTabså‡½æ•°
function renderTabs(data) {
  analysisData = data;
  
  // ç”Ÿæˆç»Ÿè®¡æ€»è§ˆæ•°æ®
  const summaryData = generateSummaryContent(data);
  data.summary = summaryData;
  
  const tabBtnHtml = gTabs.map((k, i) => 
    `<button class="tablinks" onclick="openTab(event, '${k}')">${TAB_TITLES[k]}</button>`
  ).join("");
  document.getElementById("tabBtns").innerHTML = tabBtnHtml;

  const tabContentHtml = gTabs.map(k => {
    const subTitles = SUB_TAB_TITLES[k];
    const subContent = subTitles.map(title => {
      const content = data[k] && data[k][title] ? data[k][title] : "";
      return `<details open><summary>${title}</summary><pre>${escapeHtml(content)}</pre></details>`;
    }).join("");
    return `<div id="${k}" class="tabcontent">${subContent}</div>`;
  }).join("");
  document.getElementById("tabContents").innerHTML = tabContentHtml;

  // æ˜¾ç¤ºç»Ÿè®¡é¢æ¿
  displayStatsPanel();
  
  if (gTabs.length) {
    setTimeout(() => document.getElementsByClassName("tablinks")[0].click(), 100);
  }
  
  // è°ƒç”¨è§„åˆ™å¼•æ“APIè¿›è¡Œåˆ†æ
  analyzeReport(data);
}

// æ˜¾ç¤ºç»Ÿè®¡é¢æ¿
function displayStatsPanel() {
  const stats = systemStats;
  const statsHtml = `
    <div class="stats-panel">
      <h3>ğŸ“Š ç³»ç»Ÿå®‰å…¨çŠ¶å†µæ€»è§ˆ</h3>
      <div class="risk-level risk-${stats.risk_level.toLowerCase()}">
        é£é™©ç­‰çº§: ${stats.risk_level} (è¯„åˆ†: ${stats.risk_score})
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">${stats.total_users}</div>
          <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-number ${stats.uid0_users > 0 ? 'risk-high' : ''}">${stats.uid0_users}</div>
          <div class="stat-label">å¼‚å¸¸é«˜æƒé™ç”¨æˆ·</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.listening_ports}</div>
          <div class="stat-label">ç›‘å¬ç«¯å£</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.suspicious_processes}</div>
          <div class="stat-label">å¯ç–‘è¿›ç¨‹</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.suid_files}</div>
          <div class="stat-label">SUIDæ–‡ä»¶</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.failed_logins}</div>
          <div class="stat-label">ç™»å½•å¤±è´¥</div>
        </div>
      </div>
    </div>
  `;
  
  // åœ¨å†…å®¹åŒºåŸŸé¡¶éƒ¨æ’å…¥ç»Ÿè®¡é¢æ¿
  const contentContainer = document.querySelector('.content-container');
  const existingStats = contentContainer.querySelector('.stats-panel');
  if (existingStats) {
    existingStats.remove();
  }
  contentContainer.insertAdjacentHTML('afterbegin', statsHtml);
}

function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c]));
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("fileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const text = e.target.result;
        try {
          const data = JSON.parse(text);
          renderTabs(data);
        } catch (jsonError) {
          const data = parseTextReport(text);
          renderTabs(data);
        }
      } catch (err) {
        alert("è§£æå¤±è´¥ï¼š" + err.message);
      }
    };
    reader.readAsText(file);
  });
  
  // æ·»åŠ æœç´¢å¯¼èˆªäº‹ä»¶ç›‘å¬
  document.getElementById("prevMatch").addEventListener("click", () => navigateSearch(-1));
  document.getElementById("nextMatch").addEventListener("click", () => navigateSearch(1));
});

// æ·»åŠ ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const button = document.querySelector('.collapse-button');
  if (sidebar.style.width === '0px') {
    sidebar.style.width = '350px';
    button.textContent = 'æ”¶èµ·å‘Šè­¦é¢æ¿ >';
  } else {
    sidebar.style.width = '0px';
    button.textContent = '< å±•å¼€å‘Šè­¦é¢æ¿';
  }
}

// æ·»åŠ æ˜¾ç¤ºå‘Šè­¦çš„å‡½æ•°
function displayAlerts() {
  const container = document.getElementById('alertContainer');
  const summary = document.getElementById('alertSummary');
  
  // æ¸…ç©ºç°æœ‰å†…å®¹
  container.innerHTML = '';
  summary.innerHTML = '';
  
  // æ˜¾ç¤ºå‘Šè­¦ç»Ÿè®¡
  const summaryHtml = `
    <div class="alert-badge high">
      <span>é«˜å±å‘Šè­¦</span>
      <span class="count">${alertResults.high.length}</span>
    </div>
    <div class="alert-badge medium">
      <span>ä¸­å±å‘Šè­¦</span>
      <span class="count">${alertResults.medium.length}</span>
    </div>
    <div class="alert-badge low">
      <span>ä½å±å‘Šè­¦</span>
      <span class="count">${alertResults.low.length}</span>
    </div>
  `;
  summary.innerHTML = summaryHtml;
  
  // æ˜¾ç¤ºå‘Šè­¦è¯¦æƒ…
  const alertsHtml = [
    ...alertResults.high.map(alert => `
      <div class="alert alert-high">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>å¤„ç½®å»ºè®®:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.medium.map(alert => `
      <div class="alert alert-medium">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>å¤„ç½®å»ºè®®:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.low.map(alert => `
      <div class="alert alert-low">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>å¤„ç½®å»ºè®®:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `)
  ].join('');
  
  container.innerHTML = alertsHtml;
}

function scrollToPosition(section, subsection, start, end) {
  // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${section}')"]`);
  if (tabButton) {
    tabButton.click();
  }
  
  // æ‰¾åˆ°å¯¹åº”çš„è¯¦æƒ…å…ƒç´ å¹¶å±•å¼€
  setTimeout(() => {
    const tabContent = document.getElementById(section);
    if (tabContent) {
      const details = Array.from(tabContent.querySelectorAll('details')).find(d => 
        d.querySelector('summary').textContent.includes(subsection)
      );
      if (details) {
        details.open = true;
        details.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }, 100);
}

</script>
</head>
<body>
  <div class="header">
    <h1>ğŸ›¡ï¸ Linux åº”æ€¥å“åº”æŠ¥å‘ŠæŸ¥çœ‹å™¨ (å¢å¼ºç‰ˆ)</h1>
    <div class="subtitle">æ™ºèƒ½åŒ–å®‰å…¨å¨èƒæ£€æµ‹ä¸åˆ†æç³»ç»Ÿ | ä¿ç•™åŸæœ‰åŠŸèƒ½ + å¢å¼ºç»Ÿè®¡åˆ†æ</div>
  </div>
  
  <div class="main-container">
    <div class="content-container">
      <div class="search-container">
        <input type="file" id="fileInput" accept=".txt,.json">
        <input type="text" id="searchInput" placeholder="æœç´¢æŠ¥å‘Šå†…å®¹..." onkeyup="searchTabs()">
        <div class="search-nav">
          <button id="prevMatch" onclick="navigateSearch(-1)" disabled>ä¸Šä¸€ä¸ª</button>
          <button id="nextMatch" onclick="navigateSearch(1)" disabled>ä¸‹ä¸€ä¸ª</button>
          <span id="searchCount">è¾“å…¥å…³é”®è¯æœç´¢</span>
        </div>
      </div>
      
      <div class="tabs" id="tabBtns">
        <!-- æ ‡ç­¾æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div id="tabContents">
        <!-- æ ‡ç­¾å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
    
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>ğŸš¨ å®‰å…¨å‘Šè­¦é¢æ¿</h3>
        <button class="collapse-button" onclick="toggleSidebar()">æ”¶èµ·å‘Šè­¦é¢æ¿ ></button>
        <div id="alertSummary" class="alert-summary">
          <!-- å‘Šè­¦ç»Ÿè®¡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
      </div>
      <div id="alertContainer" class="alert-container">
        <div style="text-align: center; padding: 40px; color: #666;">
          <p>ğŸ“ è¯·é€‰æ‹©æŠ¥å‘Šæ–‡ä»¶å¼€å§‹åˆ†æ</p>
          <p style="font-size: 0.9em; margin-top: 10px;">æ”¯æŒ .txt å’Œ .json æ ¼å¼</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>