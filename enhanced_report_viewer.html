<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Linux Â∫îÊÄ•ÂìçÂ∫îÊä•ÂëäÊü•ÁúãÂô® (Â¢ûÂº∫Áâà)</title>
<style>
body { 
  font-family: "Microsoft YaHei", Arial, sans-serif; 
  background: #f5f5f5; 
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: #fff;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header h1 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
}

.header h1::before {
  content: "üõ°Ô∏è";
  margin-right: 10px;
}

.header .subtitle {
  color: #7f8c8d;
  font-size: 14px;
  margin: 5px 0;
}

/* Á≥ªÁªüÁä∂ÂÜµÊÄªËßàÈù¢Êùø */
.overview-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

.overview-title {
  font-size: 18px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
}

.overview-title::before {
  content: "üìä";
  margin-right: 8px;
}

.risk-level {
  font-size: 16px;
  margin-bottom: 15px;
  padding: 8px 15px;
  background: rgba(255,255,255,0.2);
  border-radius: 5px;
  display: inline-block;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
}

.stat-item {
  text-align: center;
  background: rgba(255,255,255,0.1);
  padding: 15px 10px;
  border-radius: 8px;
  transition: transform 0.2s;
}

.stat-item:hover {
  transform: translateY(-2px);
  background: rgba(255,255,255,0.2);
}

.stat-number {
  font-size: 24px;
  font-weight: bold;
  display: block;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 12px;
  opacity: 0.9;
}

.main-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.content-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.sidebar {
  width: 300px;
  background: #fff;
  border-left: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
}

.alert-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.alert { 
  padding: 15px; 
  margin-bottom: 10px; 
  border-radius: 5px;
}

.alert-high { 
  background: #ffebee; 
  color: #c62828; 
  border-left: 5px solid #c62828; 
}

.alert-medium { 
  background: #fff3e0; 
  color: #ef6c00; 
  border-left: 5px solid #ef6c00; 
}

.alert-low { 
  background: #e3f2fd; 
  color: #1565c0; 
  border-left: 5px solid #1565c0; 
}

.alert-link { 
  cursor: pointer; 
  color: inherit; 
  text-decoration: underline; 
}

.alert-count { 
  background: #fff; 
  padding: 2px 8px; 
  border-radius: 10px; 
  margin-left: 10px; 
  font-size: 12px; 
}

.search-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

#searchInput {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  min-width: 200px;
}

.search-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.search-nav button {
  padding: 8px 15px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.search-nav button:hover {
  background: #1976D2;
}

.search-nav button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.tabs {
  overflow: hidden;
  background: #333;
  border-radius: 5px;
  margin-bottom: 10px;
}

.tabs button {
  background: #333;
  color: #fff;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 16px;
}

.tabs button:hover {
  background: #ddd;
  color: black;
}

.tabs button.active {
  background: #2196F3;
  color: white;
}

.tabcontent {
  display: none;
  padding: 20px;
  background: #fff;
  border-radius: 5px;
  margin-top: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tabcontent pre {
  background: #222;
  color: #eee;
  padding: 15px;
  border-radius: 5px;
  overflow-x: auto;
  margin: 0;
  font-size: 14px;
}

.tabcontent details {
  margin-bottom: 10px;
}

.tabcontent summary {
  cursor: pointer;
  font-weight: bold;
  padding: 10px;
  background: #f0f0f0;
  border-radius: 3px;
}

.mark {
  background: yellow;
  color: red;
  font-weight: bold;
}

.mark.current {
  background: #ff4444;
  color: white;
}

#fileInput {
  margin: 10px 0;
}

.alert-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.alert-badge {
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.alert-badge.high {
  background: #ffebee;
  color: #c62828;
}

.alert-badge.medium {
  background: #fff3e0;
  color: #ef6c00;
}

.alert-badge.low {
  background: #e3f2fd;
  color: #1565c0;
}

.alert-badge .count {
  font-weight: bold;
}

.collapse-button {
  padding: 5px 10px;
  background: none;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  margin-left: auto;
}

.collapse-button:hover {
  background: #f0f0f0;
}

@keyframes highlight-pulse {
  0% { background: #ff4444; }
  50% { background: #ff8888; }
  100% { background: #ff4444; }
}

</style>
<script>
const TAB_TITLES = {
  backdoor: "Á≥ªÁªüÂêéÈó®ÊéíÊü•",
  user: "Áî®Êà∑‰∏éÁôªÂΩïÊ£ÄÊü•",
  log: "Êó•ÂøóÂàÜÊûê",
  network: "ÁΩëÁªúÊ£ÄÊü•",
  process: "ËøõÁ®ãÊ£ÄÊü•",
  filesystem: "Êñá‰ª∂Á≥ªÁªüÊ£ÄÊü•",
  package: "ËΩØ‰ª∂ÂåÖÊ£ÄÊü•",
  persistence: "ÊåÅ‰πÖÂåñÊ£ÄÊü•",
  integrity: "Á≥ªÁªüÂÆåÊï¥ÊÄß",
  malware: "ÊÅ∂ÊÑèËøõÁ®ã‰∏éÊèêÊùÉÁÇπ",
  // summary: "ÂäüËÉΩÊÄªÁªì‰∏é‰ΩøÁî®ËØ¥Êòé"
};

const SUB_TAB_TITLES = {
  backdoor: ["UID‰∏∫0ÁöÑÈùûrootÁî®Êà∑", "ÂèØÁñëÁ≥ªÁªüÈÖçÁΩÆ", "ÂºÇÂ∏∏Á≥ªÁªüÊñá‰ª∂"],
  user: ["ÂΩìÂâçÁî®Êà∑", "ÊâÄÊúâÁî®Êà∑", "ÊúÄËøëÁôªÂΩïËÆ∞ÂΩï", "ÁôªÂΩïÂ§±Ë¥•ËÆ∞ÂΩï"],
  log: ["Á≥ªÁªüÊó•ÂøóÈîôËØØ", "ÂÆâÂÖ®Êó•ÂøóÈîôËØØ"],
  network: ["ÁõëÂê¨Á´ØÂè£", "Ê¥ªÂä®ËøûÊé•", "ÁΩëÁªúÈÖçÁΩÆ", "Ë∑ØÁî±Ë°®", "ÂèØÁñëËøûÊé•"],
  process: ["È´òCPUÂç†Áî®ËøõÁ®ã", "ÂèØÁñëËÑöÊú¨ËøõÁ®ã"],
  filesystem: ["SUIDÊñá‰ª∂", "ÊúÄËøë‰øÆÊîπÁöÑÊñá‰ª∂"],
  package: ["Â∑≤ÂÆâË£ÖÁöÑËΩØ‰ª∂ÂåÖ"],
  persistence: ["Ëá™ÂêØÂä®ÊúçÂä°", "ËÆ°Âàí‰ªªÂä°", "SSHÂÖ¨Èí•", "ÂêØÂä®È°πÈÖçÁΩÆ"],
  integrity: ["ÂÖ≥ÈîÆ‰∫åËøõÂà∂Êñá‰ª∂Ê†°È™å", "Á≥ªÁªüÊñá‰ª∂ÂÆåÊï¥ÊÄß"],
  malware: ["ÂèØÁñëËøõÁ®ã", "ÂèØÁñëÊèêÊùÉÁÇπ", "ÈöêËóèÊñá‰ª∂"],
  // summary: ["ÂäüËÉΩËØ¥Êòé"]
};

let gTabs = Object.keys(TAB_TITLES);
let gContent = "";
let currentSearchIndex = -1;
let searchResults = [];

// ÂëäË≠¶ÁªìÊûúÂ≠òÂÇ®
let alertResults = {
  high: [],
  medium: [],
  low: []
};

function parseTextReport(text) {
  const sections = text.split("##########################################");
  const data = {};
  let currentSection = null;
  
  for (const section of sections) {
    if (!section.trim()) continue;
    
    const moduleMatch = section.match(/Ê®°Âùó: (.*?)\n/);
    if (!moduleMatch) continue;
    
    const moduleTitle = moduleMatch[1];
    const moduleKey = Object.keys(TAB_TITLES).find(key => TAB_TITLES[key] === moduleTitle);
    if (!moduleKey) continue;
    
    const subSections = section.split("------------------------------------------");
    data[moduleKey] = {};
    
    for (let i = 1; i < subSections.length; i += 2) {
      const titleMatch = subSections[i].match(/Â≠êÈ°π: (.*?)\n/);
      if (!titleMatch) continue;
      const title = titleMatch[1];
      const content = subSections[i + 1] ? subSections[i + 1].trim() : "";
      data[moduleKey][title] = content;
    }
  }
  
  // Ëß£ÊûêÂÆåÊàêÂêéÊõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
  updateSystemOverview(data, text);
  
  return data;
}

// Êõ¥Êñ∞Á≥ªÁªüÁä∂ÂÜµÊÄªËßà
function updateSystemOverview(data, rawText) {
  const stats = {
    totalUsers: 0,
    suspiciousUsers: 0,
    listeningPorts: 0,
    suspiciousProcesses: 0,
    suidFiles: 0,
    loginFailures: 0
  };
  
  // ÂàÜÊûêÁî®Êà∑‰ø°ÊÅØ
  if (data.user) {
    const userContent = Object.values(data.user).join('\n');
    // ÁªüËÆ°ÊÄªÁî®Êà∑Êï∞
    const userMatches = userContent.match(/^[^:]+:/gm);
    if (userMatches) stats.totalUsers = userMatches.length;
    
    // ÁªüËÆ°UID‰∏∫0ÁöÑÈùûrootÁî®Êà∑
    const uid0Matches = userContent.match(/^(?!root:).*:x:0:0:/gm);
    if (uid0Matches) stats.suspiciousUsers = uid0Matches.length;
  }
  
  // ÂàÜÊûêÁΩëÁªú‰ø°ÊÅØ
  if (data.network) {
    const networkContent = Object.values(data.network).join('\n');
    // ÁªüËÆ°ÁõëÂê¨Á´ØÂè£
    const portMatches = networkContent.match(/LISTEN/g);
    if (portMatches) stats.listeningPorts = portMatches.length;
  }
  
  // ÂàÜÊûêËøõÁ®ã‰ø°ÊÅØ
  if (data.process) {
    const processContent = Object.values(data.process).join('\n');
    // ÁªüËÆ°ÂèØÁñëËøõÁ®ã
    const suspiciousMatches = processContent.match(/(\.sh|\.py|\.pl|\/tmp\/|\/dev\/shm\/)/g);
    if (suspiciousMatches) stats.suspiciousProcesses = suspiciousMatches.length;
  }
  
  // ÂàÜÊûêÊñá‰ª∂Á≥ªÁªü‰ø°ÊÅØ
  if (data.filesystem) {
    const fsContent = Object.values(data.filesystem).join('\n');
    // ÁªüËÆ°SUIDÊñá‰ª∂
    const suidMatches = fsContent.match(/-r.s..x..x/g);
    if (suidMatches) stats.suidFiles = suidMatches.length;
  }
  
  // ÂàÜÊûêÊó•Âøó‰ø°ÊÅØ
  if (data.log) {
    const logContent = Object.values(data.log).join('\n');
    // ÁªüËÆ°ÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞
    const failureMatches = logContent.match(/Failed password|authentication failure/gi);
    if (failureMatches) stats.loginFailures = failureMatches.length;
  }
  
  // ‰ªéÂéüÂßãÊñáÊú¨‰∏≠ÊèêÂèñÊõ¥Á≤æÁ°ÆÁöÑÁªüËÆ°‰ø°ÊÅØ
  extractDetailedStats(rawText, stats);
  
  // Êõ¥Êñ∞ÁïåÈù¢
  updateStatsDisplay(stats);
  
  // ËÆ°ÁÆóÈ£éÈô©Á≠âÁ∫ß
  const riskScore = calculateRiskScore(stats);
  updateRiskLevel(riskScore);
}

// ‰ªéÂéüÂßãÊñáÊú¨ÊèêÂèñËØ¶ÁªÜÁªüËÆ°
function extractDetailedStats(text, stats) {
  // ÊèêÂèñUID‰∏∫0Áî®Êà∑Êï∞
  const uid0Match = text.match(/„ÄêUID‰∏∫0ÁöÑÁî®Êà∑Ê£ÄÊü•„Äë[\s\S]*?(?=„Äê|$)/);
  if (uid0Match) {
    const uid0Users = uid0Match[0].match(/^[^:]+:x:0:0:/gm);
    if (uid0Users) stats.totalUsers = Math.max(stats.totalUsers, uid0Users.length);
  }
  
  // ÊèêÂèñSUIDÊñá‰ª∂Êï∞
  const suidMatch = text.match(/ÂèëÁé∞\s+(\d+)\s+‰∏™SUIDÊñá‰ª∂/);
  if (suidMatch) stats.suidFiles = parseInt(suidMatch[1]);
  
  // ÊèêÂèñÂèØÁñëËøõÁ®ãÊï∞
  const processMatch = text.match(/ÂèëÁé∞\s+(\d+)\s+‰∏™ÂèØÁñë.*?ËøõÁ®ã/);
  if (processMatch) stats.suspiciousProcesses = parseInt(processMatch[1]);
  
  // ÊèêÂèñÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞
  const failureMatch = text.match(/ÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞.*?(\d+)/);
  if (failureMatch) stats.loginFailures = parseInt(failureMatch[1]);
  
  // ÊèêÂèñÁõëÂê¨Á´ØÂè£Êï∞
  const portMatch = text.match(/ÂèëÁé∞\s+(\d+)\s+‰∏™ÁõëÂê¨Á´ØÂè£/);
  if (portMatch) stats.listeningPorts = parseInt(portMatch[1]);
}

// Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
function updateStatsDisplay(stats) {
  document.getElementById('totalUsers').textContent = stats.totalUsers;
  document.getElementById('suspiciousUsers').textContent = stats.suspiciousUsers;
  document.getElementById('listeningPorts').textContent = stats.listeningPorts;
  document.getElementById('suspiciousProcesses').textContent = stats.suspiciousProcesses;
  document.getElementById('suidFiles').textContent = stats.suidFiles;
  document.getElementById('loginFailures').textContent = stats.loginFailures;
}

// ËÆ°ÁÆóÈ£éÈô©ËØÑÂàÜ
function calculateRiskScore(stats) {
  let score = 0;
  
  // ÂèØÁñëÁî®Êà∑ÊùÉÈáçÊúÄÈ´ò
  score += stats.suspiciousUsers * 30;
  
  // ÂèØÁñëËøõÁ®ã
  score += Math.min(stats.suspiciousProcesses * 10, 50);
  
  // ÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞
  if (stats.loginFailures > 100) score += 25;
  else if (stats.loginFailures > 50) score += 15;
  else if (stats.loginFailures > 10) score += 5;
  
  // SUIDÊñá‰ª∂Êï∞Èáè
  if (stats.suidFiles > 100) score += 15;
  else if (stats.suidFiles > 50) score += 10;
  
  // ÁõëÂê¨Á´ØÂè£Êï∞Èáè
  if (stats.listeningPorts > 20) score += 10;
  else if (stats.listeningPorts > 10) score += 5;
  
  return Math.min(score, 100);
}

// Êõ¥Êñ∞È£éÈô©Á≠âÁ∫ßÊòæÁ§∫
function updateRiskLevel(score) {
  const riskElement = document.getElementById('riskLevel');
  let level, color;
  
  if (score >= 70) {
    level = 'È´òÂç±';
    color = '#e74c3c';
  } else if (score >= 40) {
    level = '‰∏≠Âç±';
    color = '#f39c12';
  } else if (score >= 20) {
    level = '‰ΩéÂç±';
    color = '#3498db';
  } else {
    level = 'NORMAL';
    color = '#27ae60';
  }
  
  riskElement.textContent = `È£éÈô©Á≠âÁ∫ß: ${level} (ËØÑÂàÜ: ${score})`;
  riskElement.style.background = color;
}

function openTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  const tablinks = document.getElementsByClassName("tablinks");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}

function findAllMatches(text, searchTerm) {
  if (!searchTerm) return [];
  const regex = new RegExp(searchTerm, 'gi');
  const matches = [];
  let match;
  while ((match = regex.exec(text)) !== null) {
    matches.push({
      index: match.index,
      text: match[0],
      position: matches.length,
      end: match.index + match[0].length
    });
  }
  return matches;
}

function searchTabs() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  if (!input) {
    updateSearchCount(0, -1);
    return;
  }

  searchResults = [];
  currentSearchIndex = -1;
  
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const tabId = tabs[i].id;
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      const preText = pres[j].textContent;
      const matches = findAllMatches(preText, input);
      matches.forEach(match => {
        searchResults.push({
          tabId,
          preIndex: j,
          ...match
        });
      });
    }
  }
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function updateSearchCount(total, current) {
  const countElement = document.getElementById("searchCount");
  if (total === 0) {
    countElement.textContent = "Êú™ÊâæÂà∞ÂåπÈÖçÈ°π";
    document.getElementById("prevMatch").disabled = true;
    document.getElementById("nextMatch").disabled = true;
  } else {
    countElement.textContent = `${current + 1}/${total}`;
    document.getElementById("prevMatch").disabled = current <= 0;
    document.getElementById("nextMatch").disabled = current >= total - 1;
  }
}

function navigateSearch(direction) {
  if (searchResults.length === 0) return;
  
  currentSearchIndex += direction;
  if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
  if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function highlightCurrentMatch() {
  // Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      let html = pres[j].innerHTML.replace(/<span class="mark.*?">(.*?)<\/span>/g, "$1");
      pres[j].innerHTML = html;
    }
  }
  
  if (searchResults.length === 0 || currentSearchIndex === -1) return;
  
  const currentMatch = searchResults[currentSearchIndex];
  
  // ÂàáÊç¢Âà∞ÂØπÂ∫îÁöÑÊ†áÁ≠æÈ°µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${currentMatch.tabId}')"]`);
  if (tabButton) {
    tabButton.click();
  }
  
  // È´ò‰∫ÆÊâÄÊúâÂåπÈÖçÈ°πÔºåÂΩìÂâçÂåπÈÖçÈ°πÁâπÊÆäÈ´ò‰∫Æ
  const searchTerm = document.getElementById("searchInput").value;
  const regex = new RegExp(`(${searchTerm})`, 'gi');
  const targetPre = document.getElementById(currentMatch.tabId)
    .getElementsByTagName("pre")[currentMatch.preIndex];
  
  targetPre.innerHTML = targetPre.textContent.replace(regex, (match, p1, offset) => {
    const isCurrentMatch = offset === currentMatch.index;
    return `<span class="mark${isCurrentMatch ? ' current' : ''}">${match}</span>`;
  });
  
  // ÊâæÂà∞ÂΩìÂâçÂåπÈÖçÈ°πÁöÑÂÖÉÁ¥†
  const currentElement = targetPre.querySelector('.mark.current');
  if (currentElement) {
    // Ëé∑ÂèñÁà∂Á∫ßdetailsÂÖÉÁ¥†
    const detailsElement = targetPre.closest('details');
    if (detailsElement && !detailsElement.open) {
      detailsElement.open = true;
    }
    
    // ËÆ°ÁÆóÊªöÂä®‰ΩçÁΩÆ
    const contentContainer = document.querySelector('.content-container');
    const elementRect = currentElement.getBoundingClientRect();
    const containerRect = contentContainer.getBoundingClientRect();
    
    // Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Âú®ËßÜÂõæ‰∏≠
    const isInView = (
      elementRect.top >= containerRect.top &&
      elementRect.bottom <= containerRect.bottom
    );
    
    if (!isInView) {
      // ËÆ°ÁÆóÁêÜÊÉ≥ÁöÑÊªöÂä®‰ΩçÁΩÆÔºàÂ∞ÜÂåπÈÖçÈ°πÊîæÂú®ÂÆπÂô®‰∏≠Èó¥Ôºâ
      const elementTop = elementRect.top + contentContainer.scrollTop - containerRect.top;
      const containerMiddle = containerRect.height / 2;
      const scrollTo = elementTop - containerMiddle + elementRect.height / 2;
      
      // Âπ≥ÊªëÊªöÂä®Âà∞ÁõÆÊ†á‰ΩçÁΩÆ
      contentContainer.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });
    }
    
    // Ê∑ªÂä†Èó™ÁÉÅÂä®Áîª‰ª•Á™ÅÂá∫ÊòæÁ§∫ÂΩìÂâçÂåπÈÖçÈ°π
    currentElement.style.animation = 'none';
    currentElement.offsetHeight; // Ëß¶ÂèëÈáçÁªò
    currentElement.style.animation = 'highlight-pulse 1s';
  }
}

// Ê∑ªÂä†ËßÑÂàôÂºïÊìéAPIË∞ÉÁî®
async function analyzeReport(data) {
  try {
    const response = await fetch('http://localhost:5000/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const results = await response.json();
    alertResults = results;
    displayAlerts();
  } catch (error) {
    console.error('ËßÑÂàôÂàÜÊûêÂ§±Ë¥•:', error);
    // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
    const container = document.getElementById('alertContainer');
    container.innerHTML = `
      <div class="alert alert-high">
        <div>
          <strong>ËßÑÂàôÂàÜÊûêÂ§±Ë¥•</strong>
          <p>Êó†Ê≥ïËøûÊé•Âà∞ËßÑÂàôÂºïÊìéÊúçÂä°Âô®ÔºåËØ∑Á°Æ‰øùÊúçÂä°Âô®Ê≠£Âú®ËøêË°å„ÄÇ</p>
          <p>ÈîôËØØ‰ø°ÊÅØ: ${error.message}</p>
        </div>
      </div>
    `;
  }
}

// ‰øÆÊîπrenderTabsÂáΩÊï∞
function renderTabs(data) {
  const tabBtnHtml = gTabs.map((k, i) => 
    `<button class="tablinks" onclick="openTab(event, '${k}')">${TAB_TITLES[k]}</button>`
  ).join("");
  document.getElementById("tabBtns").innerHTML = tabBtnHtml;

  const tabContentHtml = gTabs.map(k => {
    const subTitles = SUB_TAB_TITLES[k];
    const subContent = subTitles.map(title => {
      const content = data[k] && data[k][title] ? data[k][title] : "";
      return `<details open><summary>${title}</summary><pre>${escapeHtml(content)}</pre></details>`;
    }).join("");
    return `<div id="${k}" class="tabcontent">${subContent}</div>`;
  }).join("");
  document.getElementById("tabContents").innerHTML = tabContentHtml;

  if (gTabs.length) {
    setTimeout(() => document.getElementsByClassName("tablinks")[0].click(), 100);
  }
  
  // Ë∞ÉÁî®ËßÑÂàôÂºïÊìéAPIËøõË°åÂàÜÊûê
  analyzeReport(data);
}

function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c]));
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("fileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const text = e.target.result;
        try {
          const data = JSON.parse(text);
          renderTabs(data);
        } catch (jsonError) {
          const data = parseTextReport(text);
          renderTabs(data);
        }
      } catch (err) {
        alert("Ëß£ÊûêÂ§±Ë¥•Ôºö" + err.message);
      }
    };
    reader.readAsText(file);
  });
  
  // Ê∑ªÂä†ÊêúÁ¥¢ÂØºËà™‰∫ã‰ª∂ÁõëÂê¨
  document.getElementById("prevMatch").addEventListener("click", () => navigateSearch(-1));
  document.getElementById("nextMatch").addEventListener("click", () => navigateSearch(1));
});

// Ê∑ªÂä†‰æßËæπÊ†èÊäòÂè†ÂäüËÉΩ
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const button = document.querySelector('.collapse-button');
  if (sidebar.style.width === '0px') {
    sidebar.style.width = '300px';
    button.textContent = 'Êî∂Ëµ∑ÂëäË≠¶Èù¢Êùø >';
  } else {
    sidebar.style.width = '0px';
    button.textContent = '< Â±ïÂºÄÂëäË≠¶Èù¢Êùø';
  }
}

// Ê∑ªÂä†ÊòæÁ§∫ÂëäË≠¶ÁöÑÂáΩÊï∞
function displayAlerts() {
  const container = document.getElementById('alertContainer');
  const summary = document.getElementById('alertSummary');
  
  // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
  container.innerHTML = '';
  summary.innerHTML = '';
  
  // ÊòæÁ§∫ÂëäË≠¶ÁªüËÆ°
  const summaryHtml = `
    <div class="alert-badge high">
      <span>È´òÂç±ÂëäË≠¶</span>
      <span class="count">${alertResults.high.length}</span>
    </div>
    <div class="alert-badge medium">
      <span>‰∏≠Âç±ÂëäË≠¶</span>
      <span class="count">${alertResults.medium.length}</span>
    </div>
    <div class="alert-badge low">
      <span>‰ΩéÂç±ÂëäË≠¶</span>
      <span class="count">${alertResults.low.length}</span>
    </div>
  `;
  summary.innerHTML = summaryHtml;
  
  // ÊòæÁ§∫ÂëäË≠¶ËØ¶ÊÉÖ
  const alertsHtml = [
    ...alertResults.high.map(alert => `
      <div class="alert alert-high">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            ËßÑÂàôID: ${alert.rule_id} | Ê®°Âùó: ${alert.section} | Â≠êÈ°π: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>ÂèëÁé∞:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ‰ΩçÁΩÆ: ${finding.start}-${finding.end}, ÂåπÈÖçÊñáÊú¨: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.medium.map(alert => `
      <div class="alert alert-medium">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            ËßÑÂàôID: ${alert.rule_id} | Ê®°Âùó: ${alert.section} | Â≠êÈ°π: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>ÂèëÁé∞:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ‰ΩçÁΩÆ: ${finding.start}-${finding.end}, ÂåπÈÖçÊñáÊú¨: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.low.map(alert => `
      <div class="alert alert-low">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            ËßÑÂàôID: ${alert.rule_id} | Ê®°Âùó: ${alert.section} | Â≠êÈ°π: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>ÂèëÁé∞:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ‰ΩçÁΩÆ: ${finding.start}-${finding.end}, ÂåπÈÖçÊñáÊú¨: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `)
  ].join('');
  
  container.innerHTML = alertsHtml;
}

// Ê∑ªÂä†ÂàÜÊûêÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
function analyzeCurrentData() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    alert('ËØ∑ÂÖà‰∏ä‰º†Êñá‰ª∂');
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      let data;
      try {
        data = JSON.parse(text);
      } catch (jsonError) {
        data = parseTextReport(text);
      }
      // ÂÖàÊ∏≤ÊüìÊ†áÁ≠æÈ°µ
      renderTabs(data);
      // ÁÑ∂ÂêéÂàÜÊûêÊä•Âëä
      analyzeReport(data);
    } catch (err) {
      alert("ÂàÜÊûêÂ§±Ë¥•Ôºö" + err.message);
    }
  };
  reader.readAsText(file);
}

// Ê∑ªÂä†Ë∑≥ËΩ¨Âà∞ÊåáÂÆö‰ΩçÁΩÆÁöÑÂáΩÊï∞
function scrollToPosition(section, subsection, start, end) {
  // ÂàáÊç¢Âà∞ÂØπÂ∫îÁöÑÊ†áÁ≠æÈ°µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${section}')"]`);
  if (tabButton) {
    tabButton.click();
  }

  // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øùtabÂÜÖÂÆπÂ∑≤Ê∏≤Êüì
  setTimeout(() => {
    const details = document.querySelectorAll(`#${section} details`);
    let totalOffset = 0; // Áî®‰∫éË∑üË∏™Âú®ÊâÄÊúâpreÊ†áÁ≠æ‰∏≠ÁöÑÁ¥ØÁßØÂÅèÁßªÈáè
    
    for (const detail of details) {
      const summary = detail.querySelector('summary');
      if (!summary) continue;
      
      const pre = detail.querySelector('pre');
      if (!pre) continue;
      
      const text = pre.textContent;
      const textLength = text.length;
      
      // Ê£ÄÊü•ÁõÆÊ†á‰ΩçÁΩÆÊòØÂê¶Âú®ÂΩìÂâçpreÊ†áÁ≠æÁöÑËåÉÂõ¥ÂÜÖ
      if (start >= totalOffset && start < totalOffset + textLength) {
        detail.open = true;
        
        // ËÆ°ÁÆóÁõ∏ÂØπ‰∫éÂΩìÂâçpreÁöÑ‰ΩçÁΩÆ
        const relativeStart = start - totalOffset;
        const relativeEnd = Math.min(end - totalOffset, textLength);
        
        // Ëé∑ÂèñÁõÆÊ†áÊñáÊú¨
        const targetText = text.substring(relativeStart, relativeEnd);
        
        // Ê∏ÖÈô§ÊâÄÊúâÁé∞ÊúâÈ´ò‰∫Æ
        pre.innerHTML = escapeHtml(text);
        
        // ÈáçÊñ∞ËÆ°ÁÆó‰ΩçÁΩÆÂπ∂È´ò‰∫Æ
        const beforeText = text.substring(0, relativeStart);
        const afterText = text.substring(relativeEnd);
        
        pre.innerHTML = escapeHtml(beforeText) +
          `<span class="mark current" style="animation: highlight-pulse 1s;">${escapeHtml(targetText)}</span>` +
          escapeHtml(afterText);
        
        // ÊªöÂä®Âà∞È´ò‰∫Æ‰ΩçÁΩÆ
        const contentContainer = document.querySelector('.content-container');
        const highlightedElement = pre.querySelector('.mark.current');
        
        if (highlightedElement) {
          const preRect = pre.getBoundingClientRect();
          const elementRect = highlightedElement.getBoundingClientRect();
          const containerRect = contentContainer.getBoundingClientRect();
          
          // ËÆ°ÁÆóÊªöÂä®‰ΩçÁΩÆÔºöÂ∞ÜÈ´ò‰∫ÆÂÖÉÁ¥†Â±Ö‰∏≠ÊòæÁ§∫
          const scrollTo = (elementRect.top + contentContainer.scrollTop) - 
                         (containerRect.height / 2) + 
                         (elementRect.height / 2);
          
          contentContainer.scrollTo({
            top: scrollTo,
            behavior: 'smooth'
          });
        }
        
        break;
      }
      
      totalOffset += textLength;
    }
  }, 100);
}

// Ê∑ªÂä†‰∏Ä‰∏™Áî®‰∫éË∞ÉËØïÁöÑÂáΩÊï∞ÔºåÂ∏ÆÂä©ÂÆö‰ΩçÈóÆÈ¢ò
function debugPosition(section, subsection, start, end) {
  const details = document.querySelectorAll(`#${section} details`);
  let totalOffset = 0;
  
  for (const detail of details) {
    const summary = detail.querySelector('summary');
    if (!summary) continue;
    
    const pre = detail.querySelector('pre');
    if (!pre) continue;
    
    const text = pre.textContent;
    console.log(`Section: ${section}`);
    console.log(`Subsection: ${summary.textContent}`);
    console.log(`Text length: ${text.length}`);
    console.log(`Current total offset: ${totalOffset}`);
    console.log(`Target start-end: ${start}-${end}`);
    console.log(`Text preview: ${text.substring(Math.max(0, start - totalOffset - 10), Math.min(text.length, end - totalOffset + 10))}`);
    console.log('---');
    
    totalOffset += text.length;
  }
}
</script>
</head>
<body>
<div class="header">
  <h1>Linux Â∫îÊÄ•ÂìçÂ∫îÊä•ÂëäÊü•ÁúãÂô® (Â¢ûÂº∫Áâà)</h1>
  <div class="subtitle">‰∏ì‰∏öÂåñÂÆâÂÖ®Â®ÅËÉÅÊ£ÄÊµã‰∏éÂàÜÊûêÁ≥ªÁªü | ËØ¶ÁªÜÊó•ÂøóÂàÜÊûê + ÊîªÂáªÊ∫ØÊ∫ê + ÊäÄÊúØÊïôÁ®ã</div>
  
  <!-- Á≥ªÁªüÁä∂ÂÜµÊÄªËßàÈù¢Êùø -->
  <div class="overview-panel" id="overviewPanel">
    <div class="overview-title">Á≥ªÁªüÂÆâÂÖ®Áä∂ÂÜµÊÄªËßà</div>
    <div class="risk-level" id="riskLevel">È£éÈô©Á≠âÁ∫ß: NORMAL (ËØÑÂàÜ: 0)</div>
    <div class="stats-grid">
      <div class="stat-item">
        <span class="stat-number" id="totalUsers">0</span>
        <span class="stat-label">ÊÄªÁî®Êà∑Êï∞</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="suspiciousUsers">0</span>
        <span class="stat-label">ÂºÇÂ∏∏È´òÊùÉÈôêÁî®Êà∑</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="listeningPorts">0</span>
        <span class="stat-label">ÁõëÂê¨Á´ØÂè£</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="suspiciousProcesses">0</span>
        <span class="stat-label">ÂèØÁñëËøõÁ®ã</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="suidFiles">0</span>
        <span class="stat-label">SUIDÊñá‰ª∂</span>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="loginFailures">0</span>
        <span class="stat-label">ÁôªÂΩïÂ§±Ë¥•</span>
      </div>
    </div>
  </div>
  
  <div style="display: flex; gap: 10px; align-items: center;">
    <input type="file" id="fileInput" accept=".txt,.json">
    <button onclick="analyzeCurrentData()" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">ÂàÜÊûêÊä•Âëä</button>
  </div>
  <div class="search-container">
    <input type="text" id="searchInput" onkeyup="searchTabs()" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÈ´ò‰∫Æ...">
    <div class="search-nav">
      <button id="prevMatch" disabled>‰∏ä‰∏Ä‰∏™</button>
      <span id="searchCount" class="search-count">0/0</span>
      <button id="nextMatch" disabled>‰∏ã‰∏Ä‰∏™</button>
    </div>
    <button class="collapse-button" onclick="toggleSidebar()">Êî∂Ëµ∑ÂëäË≠¶Èù¢Êùø ></button>
  </div>
  <div id="alertSummary" class="alert-summary"></div>
</div>

<div class="main-container">
  <div class="content-container">
    <div class="tabs" id="tabBtns"></div>
    <div id="tabContents"></div>
  </div>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3 style="margin: 0;">ÂëäË≠¶‰ø°ÊÅØ</h3>
    </div>
    <div id="alertContainer" class="alert-container"></div>
  </div>
</div>
</body>
</html>

