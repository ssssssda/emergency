<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Linux 应急响应报告查看器 (详细版)</title>
<style>
body { 
  font-family: "Microsoft YaHei", Arial, sans-serif; 
  background: #f5f5f5; 
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  color: white;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header h1 {
  margin: 0 0 15px 0;
  font-size: 2.2em;
}

.header .subtitle {
  font-size: 1.1em;
  opacity: 0.9;
}

.main-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.content-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.sidebar {
  width: 350px;
  background: #fff;
  border-left: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
}

.alert-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.alert { 
  padding: 15px; 
  margin-bottom: 10px; 
  border-radius: 5px;
}

.alert-high { 
  background: #ffebee; 
  color: #c62828; 
  border-left: 5px solid #c62828; 
}

.alert-medium { 
  background: #fff3e0; 
  color: #ef6c00; 
  border-left: 5px solid #ef6c00; 
}

.alert-low { 
  background: #e3f2fd; 
  color: #1565c0; 
  border-left: 5px solid #1565c0; 
}

.alert-link { 
  cursor: pointer; 
  color: inherit; 
  text-decoration: underline; 
}

.alert-count { 
  background: #fff; 
  padding: 2px 8px; 
  border-radius: 10px; 
  margin-left: 10px; 
  font-size: 12px; 
}

.search-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

#searchInput {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  min-width: 200px;
}

.search-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.search-nav button {
  padding: 8px 15px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.search-nav button:hover {
  background: #1976D2;
}

.search-nav button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.tabs {
  overflow: hidden;
  background: #333;
  border-radius: 5px;
  margin-bottom: 10px;
  display: flex;
  flex-wrap: wrap;
}

.tabs button {
  background: #333;
  color: #fff;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 14px;
  flex: 1;
  min-width: 120px;
}

.tabs button:hover {
  background: #ddd;
  color: black;
}

.tabs button.active {
  background: #2196F3;
  color: white;
}

.tabcontent {
  display: none;
  padding: 20px;
  background: #fff;
  border-radius: 5px;
  margin-top: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tabcontent pre {
  background: #222;
  color: #eee;
  padding: 15px;
  border-radius: 5px;
  overflow-x: auto;
  margin: 0;
  font-size: 14px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.tabcontent details {
  margin-bottom: 15px;
  border: 1px solid #e0e0e0;
  border-radius: 5px;
}

.tabcontent summary {
  cursor: pointer;
  font-weight: bold;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 5px 5px 0 0;
  border-bottom: 1px solid #e0e0e0;
  transition: background 0.3s;
}

.tabcontent summary:hover {
  background: #e9ecef;
}

.tabcontent details[open] summary {
  background: #007bff;
  color: white;
}

.mark {
  background: yellow;
  color: red;
  font-weight: bold;
}

.mark.current {
  background: #ff4444;
  color: white;
}

#fileInput {
  margin: 10px 0;
}

.alert-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.alert-badge {
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: bold;
}

.alert-badge.high {
  background: #ffebee;
  color: #c62828;
}

.alert-badge.medium {
  background: #fff3e0;
  color: #ef6c00;
}

.alert-badge.low {
  background: #e3f2fd;
  color: #1565c0;
}

.alert-badge .count {
  background: rgba(255,255,255,0.8);
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
}

.collapse-button {
  padding: 5px 10px;
  background: none;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  margin-left: auto;
}

.collapse-button:hover {
  background: #f0f0f0;
}

/* 统计面板样式 */
.stats-panel {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.stat-item {
  background: rgba(255,255,255,0.1);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  backdrop-filter: blur(10px);
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.9em;
  opacity: 0.9;
}

.risk-level {
  display: inline-block;
  padding: 5px 15px;
  border-radius: 20px;
  font-weight: bold;
  margin: 10px 0;
}

.risk-high { background: #ff4757; color: white; }
.risk-medium { background: #ffa502; color: white; }
.risk-low { background: #3742fa; color: white; }
.risk-normal { background: #2ed573; color: white; }

/* 建议面板样式 */
.recommendations-panel {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  border-left: 5px solid #28a745;
}

.recommendation-item {
  background: white;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.recommendation-level {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  margin-right: 10px;
}

.level-high { background: #ff4757; color: white; }
.level-medium { background: #ffa502; color: white; }
.level-low { background: #3742fa; color: white; }
.level-info { background: #2ed573; color: white; }

@keyframes highlight-pulse {
  0% { background: #ff4444; }
  50% { background: #ff8888; }
  100% { background: #ff4444; }
}

/* 教程样式 */
.tutorial-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  line-height: 1.6;
}

.tutorial-section {
  margin-bottom: 30px;
  padding: 20px;
  border: 1px solid #e1e8ed;
  border-radius: 8px;
  background: #f8f9fa;
}

.tutorial-section h4 {
  color: #2c3e50;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #3498db;
}

.step-by-step .step {
  margin-bottom: 25px;
  padding: 15px;
  background: white;
  border-radius: 6px;
  border-left: 4px solid #3498db;
}

.command-block {
  background: #2c3e50;
  color: #ecf0f1;
  padding: 15px;
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  margin: 10px 0;
  overflow-x: auto;
}

.command-block code {
  color: #2ecc71;
  font-weight: bold;
}

.tip {
  background: #e8f5e8;
  border: 1px solid #27ae60;
  border-radius: 6px;
  padding: 10px;
  margin-top: 10px;
  color: #27ae60;
}

.warning-box {
  background: #fdf2e9;
  border: 1px solid #e67e22;
  border-radius: 6px;
  padding: 15px;
  color: #d35400;
}

.tool-list .tool-item {
  background: white;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 6px;
  border-left: 4px solid #9b59b6;
}

.process-flow .process-step {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 12px 20px;
  margin-bottom: 8px;
  border-radius: 25px;
  font-weight: bold;
}

.attack-patterns .pattern-item {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
  border-left: 4px solid #e74c3c;
}

.detection-methods .method-item {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
  border-left: 4px solid #f39c12;
}

.response-actions .action-item {
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
}

.action-item.urgent {
  background: #ffebee;
  border-left: 4px solid #f44336;
}

.action-item.medium {
  background: #fff8e1;
  border-left: 4px solid #ff9800;
}

.action-item.low {
  background: #e8f5e8;
  border-left: 4px solid #4caf50;
}

.hardening-tips .tip-category {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
  border-left: 4px solid #2196f3;
}

.suspicious-signs h5 {
  margin-top: 15px;
  margin-bottom: 10px;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .main-container {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    max-height: 300px;
  }
  
  .tabs {
    flex-direction: column;
  }
  
  .tabs button {
    flex: none;
  }
  
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  }
}

</style>
<script>
const TAB_TITLES = {
  summary: "📊 统计分析总览",
  backdoor: "🔍 系统后门排查",
  user: "👥 用户与登录检查",
  log: "📋 日志分析",
  network: "🌐 网络检查",
  process: "⚙️ 进程检查",
  filesystem: "📁 文件系统检查",
  package: "📦 软件包检查",
  persistence: "🔄 持久化检查",
  integrity: "🛡️ 系统完整性",
  malware: "🦠 恶意进程与提权点"
};

const SUB_TAB_TITLES = {
  summary: ["系统概览", "风险评估", "智能建议", "检查清单", "专业总结"],
  backdoor: ["📚 排查教程", "UID为0的非root用户", "可疑系统配置", "异常系统文件"],
  user: ["📚 排查教程", "当前用户", "所有用户", "最近登录记录", "登录失败记录"],
  log: ["📚 排查教程", "SSH攻击统计分析", "登录会话分析", "系统日志错误", "数据传输异常分析", "攻击模式识别", "IP地理位置分析", "安全事件时间线"],
  network: ["📚 排查教程", "监听端口", "活动连接", "网络配置", "路由表", "可疑连接"],
  process: ["📚 排查教程", "高CPU占用进程", "可疑脚本进程"],
  filesystem: ["📚 排查教程", "SUID文件", "最近修改的文件"],
  package: ["📚 排查教程", "已安装的软件包"],
  persistence: ["📚 排查教程", "自启动服务", "计划任务", "SSH公钥", "启动项配置"],
  integrity: ["📚 排查教程", "关键二进制文件校验", "系统文件完整性"],
  malware: ["📚 排查教程", "可疑进程", "可疑提权点", "隐藏文件"]
};

let gTabs = Object.keys(TAB_TITLES);
let gContent = "";
let currentSearchIndex = -1;
let searchResults = [];
let analysisData = null;

// 告警结果存储
let alertResults = {
  high: [],
  medium: [],
  low: []
};

// 统计数据存储
let systemStats = {
  total_users: 0,
  uid0_users: 0,
  listening_ports: 0,
  suspicious_processes: 0,
  suid_files: 0,
  recent_files: 0,
  failed_logins: 0,
  cron_jobs: 0,
  risk_score: 0,
  risk_level: 'NORMAL'
};

function parseTextReport(text) {
  const sections = text.split("##########################################");
  const data = {};
  let currentSection = null;
  
  for (const section of sections) {
    if (!section.trim()) continue;
    
    const moduleMatch = section.match(/模块: (.*?)\n/);
    if (!moduleMatch) continue;
    
    const moduleTitle = moduleMatch[1];
    const moduleKey = Object.keys(TAB_TITLES).find(key => TAB_TITLES[key].includes(moduleTitle) || TAB_TITLES[key] === moduleTitle);
    if (!moduleKey) continue;
    
    const subSections = section.split("------------------------------------------");
    data[moduleKey] = {};
    
    for (let i = 1; i < subSections.length; i += 2) {
      const titleMatch = subSections[i].match(/子项: (.*?)\n/);
      if (!titleMatch) continue;
      const title = titleMatch[1];
      const content = subSections[i + 1] ? subSections[i + 1].trim() : "";
      data[moduleKey][title] = content;
    }
  }
  
  return data;
}

// 生成统计分析
function generateStatistics(data) {
  const stats = {
    system_overview: {},
    security_summary: {},
    risk_assessment: {},
    recommendations: []
  };
  
  // 重置统计数据
  systemStats = {
    total_users: 0,
    uid0_users: 0,
    listening_ports: 0,
    suspicious_processes: 0,
    suid_files: 0,
    recent_files: 0,
    failed_logins: 0,
    cron_jobs: 0,
    risk_score: 0,
    risk_level: 'NORMAL'
  };
  
  // 用户统计
  if (data.user && data.user['所有用户']) {
    const users = data.user['所有用户'].split('\n').filter(u => u.trim());
    systemStats.total_users = users.length;
  }
  
  if (data.backdoor && data.backdoor['UID为0的非root用户']) {
    const uid0Content = data.backdoor['UID为0的非root用户'];
    systemStats.uid0_users = (uid0Content.match(/可疑UID 0用户/g) || []).length;
  }
  
  // 网络统计
  if (data.network && data.network['监听端口']) {
    const ports = data.network['监听端口'];
    systemStats.listening_ports = (ports.match(/LISTEN|:/g) || []).length;
  }
  
  // 进程统计
  if (data.process && data.process['可疑脚本进程']) {
    const processes = data.process['可疑脚本进程'].split('\n').filter(p => p.trim());
    systemStats.suspicious_processes = processes.length;
  }
  
  // 文件系统统计
  if (data.filesystem && data.filesystem['SUID文件']) {
    const suidFiles = data.filesystem['SUID文件'];
    systemStats.suid_files = (suidFiles.match(/-rws/g) || []).length;
  }
  
  if (data.filesystem && data.filesystem['最近修改的文件']) {
    const recentFiles = data.filesystem['最近修改的文件'].split('\n').filter(f => f.trim());
    systemStats.recent_files = recentFiles.length;
  }
  
  // 登录失败统计
  if (data.user && data.user['登录失败记录']) {
    const failedLogins = data.user['登录失败记录'];
    systemStats.failed_logins = (failedLogins.match(/Failed password/g) || []).length;
  }
  
  // 计划任务统计
  if (data.persistence && data.persistence['计划任务']) {
    const cronJobs = data.persistence['计划任务'];
    systemStats.cron_jobs = (cronJobs.match(/crontab|cron|\*/g) || []).length;
  }
  
  // 风险评分计算
  let riskScore = 0;
  const recommendations = [];
  
  if (systemStats.uid0_users > 0) {
    riskScore += 50;
    recommendations.push({
      level: 'high',
      title: '发现异常高权限用户',
      description: `发现 ${systemStats.uid0_users} 个非root的UID为0用户，这可能是安全威胁。`,
      action: '建议立即与运维和开发人员确认这些用户的合法性，如无法确认应立即禁用。'
    });
  } else {
    recommendations.push({
      level: 'info',
      title: '用户权限检查正常',
      description: `系统共有 ${systemStats.total_users} 个用户账户，除root外未发现其他UID为0的高权限用户，这是良好的安全实践。`,
      action: '建议定期审查用户账户，确保权限分配合理。'
    });
  }

  // 增强的用户分析
  if (systemStats.total_users === 0) {
    recommendations.push({
      level: 'warning',
      title: '用户信息获取异常',
      description: '未能获取到系统用户信息，可能是权限不足或系统异常。',
      action: '建议检查脚本执行权限，确保以root权限运行，或检查/etc/passwd文件是否可读。'
    });
  } else if (systemStats.total_users < 5) {
    recommendations.push({
      level: 'info',
      title: '系统用户数量较少',
      description: `系统仅有 ${systemStats.total_users} 个用户账户，这通常表明是一个精简的生产系统。`,
      action: '建议确认所有用户账户都是必需的，定期清理不活跃的账户。'
    });
  } else if (systemStats.total_users > 20) {
    recommendations.push({
      level: 'medium',
      title: '系统用户数量较多',
      description: `系统有 ${systemStats.total_users} 个用户账户，用户数量较多可能增加安全风险。`,
      action: '建议与运维团队确认所有用户的必要性，禁用或删除不活跃的账户，实施最小权限原则。'
    });
  }
  
  // 网络端口分析
  if (systemStats.listening_ports === 0) {
    recommendations.push({
      level: 'warning',
      title: '未检测到监听端口',
      description: '系统未检测到任何监听端口，这可能表明网络服务未启动或检测异常。',
      action: '建议检查网络服务状态，确认是否为预期配置。如果是服务器，通常应该有一些必要的服务端口。'
    });
  } else if (systemStats.listening_ports > 20) {
    riskScore += 20;
    recommendations.push({
      level: 'medium',
      title: '监听端口数量较多',
      description: `系统监听了 ${systemStats.listening_ports} 个端口，端口数量较多可能增加攻击面。`,
      action: '建议与运维团队逐一确认每个监听端口的必要性，关闭不必要的服务，减少潜在的攻击入口。'
    });
  } else if (systemStats.listening_ports > 0 && systemStats.listening_ports <= 5) {
    recommendations.push({
      level: 'info',
      title: '网络服务配置合理',
      description: `系统监听 ${systemStats.listening_ports} 个端口，数量适中，符合安全最佳实践。`,
      action: '建议定期审查监听服务，确保所有服务都是业务必需的。'
    });
  }

  // SUID文件分析
  if (systemStats.suid_files === 0) {
    recommendations.push({
      level: 'warning',
      title: 'SUID文件检测异常',
      description: '未检测到任何SUID文件，这可能表明检测异常，正常系统应该有一些系统SUID文件。',
      action: '建议检查find命令是否正常执行，或者系统是否为容器环境。'
    });
  } else if (systemStats.suid_files > 100) {
    riskScore += 25;
    recommendations.push({
      level: 'high',
      title: 'SUID文件数量异常',
      description: `发现 ${systemStats.suid_files} 个SUID文件，数量异常偏多，可能存在提权风险。`,
      action: '建议立即检查SUID文件列表，特别关注/tmp、/var/tmp等临时目录中的SUID文件，与运维团队确认异常文件的来源。'
    });
  } else if (systemStats.suid_files > 50) {
    riskScore += 10;
    recommendations.push({
      level: 'medium',
      title: 'SUID文件需要关注',
      description: `发现 ${systemStats.suid_files} 个SUID文件，数量偏多，建议审查。`,
      action: '建议检查SUID文件列表，确认所有文件都是系统必需的，移除不必要的SUID权限。'
    });
  }

  // 登录失败分析
  if (systemStats.failed_logins > 100) {
    riskScore += 40;
    recommendations.push({
      level: 'high',
      title: '检测到大量登录失败',
      description: `发现 ${systemStats.failed_logins} 次登录失败，可能正在遭受暴力破解攻击。`,
      action: '建议立即检查登录日志，识别攻击源IP，考虑实施IP封禁、修改SSH端口、启用fail2ban等防护措施。'
    });
  } else if (systemStats.failed_logins > 20) {
    riskScore += 15;
    recommendations.push({
      level: 'medium',
      title: '登录失败次数较多',
      description: `发现 ${systemStats.failed_logins} 次登录失败，需要关注潜在的安全威胁。`,
      action: '建议检查登录日志，分析失败原因，如果是外部攻击应加强访问控制。'
    });
  } else if (systemStats.failed_logins === 0) {
    recommendations.push({
      level: 'info',
      title: '登录安全状况良好',
      description: '未发现登录失败记录，系统登录安全状况良好。',
      action: '建议保持当前的安全配置，定期监控登录日志。'
    });
  }

  if (systemStats.suspicious_processes > 10) {
    riskScore += 30;
    recommendations.push({
      level: 'medium',
      title: '可疑进程数量异常',
      description: `发现 ${systemStats.suspicious_processes} 个可疑脚本进程，数量较多。`,
      action: '建议检查这些进程的合法性，确认其业务必要性。'
    });
  } else if (systemStats.suspicious_processes > 0) {
    recommendations.push({
      level: 'low',
      title: '发现少量可疑进程',
      description: `发现 ${systemStats.suspicious_processes} 个可疑脚本进程。`,
      action: '建议确认这些进程的业务必要性。'
    });
  }
  
  if (systemStats.suid_files > 100) {
    riskScore += 20;
    recommendations.push({
      level: 'medium',
      title: 'SUID文件数量异常',
      description: `发现 ${systemStats.suid_files} 个SUID文件，数量较多。`,
      action: '建议审查SUID文件列表，确认是否存在异常的提权文件。'
    });
  }
  
  if (systemStats.failed_logins > 50) {
    riskScore += 25;
    recommendations.push({
      level: 'medium',
      title: '登录失败次数异常',
      description: `登录失败次数(${systemStats.failed_logins})较多，可能存在暴力破解攻击。`,
      action: '建议检查登录日志，加强密码策略和访问控制。'
    });
  }
  
  if (systemStats.listening_ports > 20) {
    riskScore += 15;
    recommendations.push({
      level: 'low',
      title: '监听端口数量较多',
      description: `监听端口数量(${systemStats.listening_ports})较多。`,
      action: '建议关闭不必要的服务以减少攻击面。'
    });
  }
  
  // 确定风险等级
  if (riskScore >= 80) {
    systemStats.risk_level = 'HIGH';
  } else if (riskScore >= 50) {
    systemStats.risk_level = 'MEDIUM';
  } else if (riskScore >= 20) {
    systemStats.risk_level = 'LOW';
  } else {
    systemStats.risk_level = 'NORMAL';
  }
  
  systemStats.risk_score = riskScore;
  
  return {
    statistics: systemStats,
    recommendations: recommendations
  };
}

// 生成统计总览内容
function generateSummaryContent(data) {
  const analysis = generateStatistics(data);
  const stats = analysis.statistics;
  const recommendations = analysis.recommendations;
  
  const summaryData = {
    '系统概览': `
=== 系统基本信息 ===
检查时间: ${new Date().toLocaleString()}
总用户数: ${stats.total_users}
UID为0的非root用户: ${stats.uid0_users}
监听端口数: ${stats.listening_ports}
可疑进程数: ${stats.suspicious_processes}
SUID文件数: ${stats.suid_files}
最近修改文件数: ${stats.recent_files}
登录失败次数: ${stats.failed_logins}
计划任务数: ${stats.cron_jobs}

=== 风险评估 ===
风险评分: ${stats.risk_score}
风险等级: ${stats.risk_level}
    `,
    
    '风险评估': `
=== 风险等级说明 ===
NORMAL (0-19分): 系统安全状况良好
LOW (20-49分): 存在轻微安全风险
MEDIUM (50-79分): 存在中等安全风险，需要关注
HIGH (80+分): 存在严重安全风险，需要立即处理

=== 当前风险分析 ===
总评分: ${stats.risk_score} 分
风险等级: ${stats.risk_level}

评分构成:
- UID为0异常用户: ${stats.uid0_users > 0 ? '+50分 (高危)' : '0分 (正常)'}
- 可疑进程过多: ${stats.suspicious_processes > 10 ? '+30分 (中危)' : stats.suspicious_processes > 0 ? '+10分 (低危)' : '0分 (正常)'}
- SUID文件异常: ${stats.suid_files > 100 ? '+20分 (中危)' : '0分 (正常)'}
- 登录失败过多: ${stats.failed_logins > 50 ? '+25分 (中危)' : '0分 (正常)'}
- 监听端口过多: ${stats.listening_ports > 20 ? '+15分 (低危)' : '0分 (正常)'}
    `,
    
    '智能建议': recommendations.map(rec => 
      `[${rec.level.toUpperCase()}] ${rec.title}\n${rec.description}\n处置建议: ${rec.action}`
    ).join('\n\n'),
    
    '检查清单': generateProfessionalSummary(data, stats),
    
    '专业总结': generateIncidentResponseSummary(data, stats)
  };
  
  return summaryData;
}

// 生成专业检查清单
function generateProfessionalSummary(data, stats) {
  return `
=== 应急响应检查清单 (基于NIST SP 800-61框架) ===

【准备阶段 - Preparation】
□ 1. 确认应急响应团队联系方式和职责分工
□ 2. 验证备份系统和恢复程序的可用性
□ 3. 确保日志记录和监控系统正常运行

【检测与分析阶段 - Detection & Analysis】
□ 4. 确认所有UID为0的用户合法性 ${stats.uid0_users > 0 ? '⚠️ 发现异常' : '✅ 正常'}
□ 5. 分析可疑进程的业务必要性 ${stats.suspicious_processes > 10 ? '⚠️ 数量异常' : '✅ 正常范围'}
□ 6. 审查SUID文件是否存在异常提权点
□ 7. 分析登录失败日志，识别潜在的暴力破解攻击 ${stats.failed_logins > 50 ? '⚠️ 失败次数过多' : '✅ 正常'}
□ 8. 检查网络连接和监听端口的合法性 ${stats.listening_ports > 20 ? '⚠️ 端口较多' : '✅ 正常'}

【遏制阶段 - Containment】
□ 9. 隔离可疑系统和网络连接
□ 10. 保护关键数据和系统资源
□ 11. 收集和保存数字证据

【根除阶段 - Eradication】
□ 12. 清除恶意软件和后门程序
□ 13. 修复系统漏洞和安全配置
□ 14. 更新系统补丁和安全策略

【恢复阶段 - Recovery】
□ 15. 验证系统完整性和功能正常
□ 16. 恢复业务服务和数据访问
□ 17. 加强监控和日志记录

【事后活动 - Post-Incident Activity】
□ 18. 编写详细的事件报告
□ 19. 总结经验教训和改进建议
□ 20. 更新应急响应程序和预案

=== 优先级处理建议 ===
${stats.uid0_users > 0 ? '🔴 紧急 (P0): 立即处理UID为0异常用户，可能存在权限提升威胁' : ''}
${stats.risk_score >= 80 ? '🔴 高危 (P1): 系统存在严重安全风险，需要立即响应' : ''}
${stats.risk_score >= 50 && stats.risk_score < 80 ? '🟡 中危 (P2): 存在安全隐患，建议24小时内处理' : ''}
${stats.risk_score >= 20 && stats.risk_score < 50 ? '🟢 低危 (P3): 优化安全配置，建议72小时内处理' : ''}
${stats.risk_score < 20 ? '✅ 正常 (P4): 系统安全状况良好，建议定期检查维护' : ''}
  `;
}

// 生成专业的事件响应总结
function generateIncidentResponseSummary(data, stats) {
  const currentTime = new Date().toLocaleString();
  
  // 分析已确认安全的项目
  const secureItems = [];
  if (stats.uid0_users === 0) secureItems.push('用户权限配置');
  if (stats.failed_logins < 10) secureItems.push('登录安全状况');
  if (stats.suspicious_processes < 5) secureItems.push('进程运行状态');
  
  // 需要与运维确认的项目
  const confirmItems = [];
  if (stats.listening_ports > 10) confirmItems.push(`网络服务配置(${stats.listening_ports}个监听端口)`);
  if (stats.cron_jobs > 5) confirmItems.push(`计划任务配置(${stats.cron_jobs}个任务)`);
  if (stats.suid_files > 50) confirmItems.push(`SUID文件权限(${stats.suid_files}个文件)`);
  
  // 已确认存在威胁的项目
  const threatItems = [];
  if (stats.uid0_users > 0) threatItems.push(`异常高权限用户(${stats.uid0_users}个)`);
  if (stats.failed_logins > 50) threatItems.push(`暴力破解攻击迹象(${stats.failed_logins}次失败)`);
  
  // 未完成检查的项目
  const pendingItems = [
    '深度恶意软件扫描',
    '网络流量异常分析',
    '文件完整性深度校验',
    '内存转储分析',
    '系统调用审计'
  ];
  
  return `
=== 网络安全事件响应总结报告 ===
报告生成时间: ${currentTime}
分析师: 自动化应急响应系统
事件等级: ${stats.risk_level} (评分: ${stats.risk_score}/100)

【执行摘要 - Executive Summary】
本次应急响应检查基于NIST SP 800-61网络安全事件处理指南执行，采用标准化的检测、分析、遏制、根除、恢复流程。通过自动化工具对目标系统进行了全面的安全态势评估。

【已确认安全的检查项目 - Verified Secure Items】
${secureItems.length > 0 ? secureItems.map(item => `✅ ${item}: 经检查确认符合安全基线要求`).join('\n') : '⚠️ 暂无完全确认安全的项目，建议进一步深入分析'}

【需要运维确认的业务合规性项目 - Items Requiring Operational Validation】
${confirmItems.length > 0 ? confirmItems.map(item => `🔍 ${item}: 建议与运维团队确认业务合规性和必要性`).join('\n') : '✅ 所有配置项目均在正常范围内'}

【已识别的安全威胁 - Confirmed Security Threats】
${threatItems.length > 0 ? threatItems.map(item => `🚨 ${item}: 已确认存在安全风险，建议立即采取遏制措施`).join('\n') : '✅ 未发现明确的安全威胁指标'}

【待深入检查的项目 - Pending Advanced Analysis】
${pendingItems.map(item => `⏳ ${item}: 建议使用专业工具进行深度分析`).join('\n')}

【建议后续行动 - Recommended Next Actions】
1. 【立即行动】针对已识别威胁执行遏制和根除措施
2. 【24小时内】与运维团队确认可疑配置的业务合规性
3. 【72小时内】执行深度安全扫描和威胁狩猎活动
4. 【一周内】更新安全基线和监控规则
5. 【持续监控】加强日志分析和异常行为检测

【合规性声明 - Compliance Statement】
本次检查遵循以下安全框架和标准:
• NIST Cybersecurity Framework 2.0
• NIST SP 800-61 Rev.3 事件响应指南
• ISO/IEC 27035 信息安全事件管理
• SANS 事件响应六步法

【免责声明 - Disclaimer】
本报告基于自动化工具生成，仅供参考。建议结合人工分析和专业安全团队的判断，制定最终的安全响应策略。对于关键业务系统，建议咨询专业的网络安全服务提供商。

---
报告编号: IR-${Date.now()}
分类级别: 内部使用
有效期限: 30天
  `;
}

// 生成教程内容
function generateTutorial(category) {
  const tutorials = {
    backdoor: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>🛡️ 系统后门排查完全指南</h3>

<h4>📖 什么是系统后门？</h4>
<p>系统后门是攻击者在获得系统访问权限后，为了维持持久化访问而植入的隐蔽通道。后门可以是文件、进程、服务或系统配置的修改。</p>

<h4>🔍 后门排查的核心思路</h4>
<ol>
<li><strong>权限异常检查</strong> - 查找不应该存在的高权限用户</li>
<li><strong>文件完整性验证</strong> - 检查系统关键文件是否被篡改</li>
<li><strong>进程行为分析</strong> - 识别可疑的运行进程</li>
<li><strong>网络连接监控</strong> - 发现异常的网络通信</li>
<li><strong>启动项检查</strong> - 确认自启动程序的合法性</li>
</ol>

<h4>💻 关键排查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 检查UID为0的用户（超级用户权限）
awk -F: '$3==0 {print $1}' /etc/passwd

# 2. 查找SUID文件（可能的提权点）
find / -perm -4000 -type f 2>/dev/null

# 3. 检查最近修改的系统文件
find /bin /sbin /usr/bin /usr/sbin -mtime -7 -type f

# 4. 查看隐藏文件和目录
find / -name ".*" -type f 2>/dev/null | grep -v proc | head -20

# 5. 检查异常的网络监听
netstat -tulnp | grep LISTEN
</div>

<h4>🚨 常见后门特征</h4>
<ul>
<li><strong>UID为0的非root用户</strong> - 除了root外不应该有其他UID为0的用户</li>
<li><strong>异常SUID文件</strong> - 特别是在/tmp、/var/tmp等临时目录</li>
<li><strong>可疑的隐藏文件</strong> - 以点开头的异常文件</li>
<li><strong>修改的系统二进制文件</strong> - ls、ps、netstat等被替换</li>
<li><strong>异常的网络监听端口</strong> - 不明来源的监听服务</li>
</ul>

<h4>🔧 排查技巧与经验</h4>
<ol>
<li><strong>对比基线</strong> - 与正常系统的配置进行对比</li>
<li><strong>时间关联</strong> - 关注文件修改时间与入侵时间的关联</li>
<li><strong>进程父子关系</strong> - 使用pstree查看进程树结构</li>
<li><strong>文件哈希校验</strong> - 对关键文件进行MD5/SHA校验</li>
<li><strong>日志分析</strong> - 结合系统日志进行综合分析</li>
</ol>

<h4>⚠️ 注意事项</h4>
<ul>
<li>排查过程中避免惊动攻击者，先收集证据再处置</li>
<li>对可疑文件进行备份，便于后续分析</li>
<li>使用可信的外部工具进行检查，避免使用被篡改的系统命令</li>
<li>记录所有发现的异常，建立完整的事件时间线</li>
</ul>
</div>
    `,
    
    user: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>👥 用户与登录安全检查指南</h3>

<h4>📖 用户安全检查的重要性</h4>
<p>用户账户是系统安全的第一道防线。攻击者常常通过创建后门账户、提升权限或利用弱密码来维持系统访问。</p>

<h4>🔍 用户检查的核心要点</h4>
<ol>
<li><strong>账户合法性验证</strong> - 确认所有用户账户的合法性</li>
<li><strong>权限等级审查</strong> - 检查用户权限是否合理</li>
<li><strong>登录行为分析</strong> - 识别异常的登录模式</li>
<li><strong>密码策略检查</strong> - 验证密码安全策略</li>
<li><strong>sudo权限审计</strong> - 检查特权用户配置</li>
</ol>

<h4>💻 关键检查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 查看所有用户账户
cat /etc/passwd | cut -d: -f1,3,4,5,6,7

# 2. 检查有登录权限的用户
grep -v '/nologin\\|/false' /etc/passwd

# 3. 查看用户组信息
cat /etc/group

# 4. 检查sudo权限配置
cat /etc/sudoers
visudo -c

# 5. 查看最近登录记录
last -20
lastlog

# 6. 检查当前登录用户
who -a
w

# 7. 查看用户密码策略
chage -l username
</div>

<h4>🚨 异常用户特征</h4>
<ul>
<li><strong>UID为0的非root用户</strong> - 具有超级用户权限的可疑账户</li>
<li><strong>无家目录的用户</strong> - 家目录不存在或异常的用户</li>
<li><strong>异常shell的用户</strong> - 使用非标准shell的账户</li>
<li><strong>最近创建的用户</strong> - 入侵时间附近创建的新用户</li>
<li><strong>异常登录时间</strong> - 非工作时间的登录活动</li>
</ul>

<h4>🔧 登录安全分析技巧</h4>
<ol>
<li><strong>登录频率分析</strong> - 识别异常高频的登录尝试</li>
<li><strong>IP地址关联</strong> - 分析登录来源的地理位置</li>
<li><strong>失败登录模式</strong> - 识别暴力破解攻击</li>
<li><strong>会话持续时间</strong> - 分析异常长时间的会话</li>
<li><strong>并发登录检查</strong> - 发现同一用户的多点登录</li>
</ol>

<h4>⚠️ 安全建议</h4>
<ul>
<li>定期审查用户账户，删除不必要的账户</li>
<li>实施强密码策略和定期密码更换</li>
<li>启用登录失败锁定机制</li>
<li>使用SSH密钥认证替代密码认证</li>
<li>监控和记录所有用户登录活动</li>
</ul>
</div>
    `,
    
    log: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>📋 日志分析与攻击检测指南</h3>

<h4>📖 日志分析的重要性</h4>
<p>系统日志是安全事件的重要证据来源，通过专业的日志分析可以发现攻击痕迹、重建攻击时间线，并评估安全事件的影响范围。</p>

<h4>🔍 日志分析的核心方法</h4>
<ol>
<li><strong>攻击模式识别</strong> - 识别暴力破解、扫描等攻击行为</li>
<li><strong>时间线重建</strong> - 构建完整的安全事件时间线</li>
<li><strong>IP信誉分析</strong> - 分析攻击来源的威胁情报</li>
<li><strong>行为基线对比</strong> - 与正常行为模式进行对比</li>
<li><strong>关联分析</strong> - 多维度关联分析发现隐蔽威胁</li>
</ol>

<h4>💻 日志分析关键命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. SSH暴力破解检测
grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# 2. 成功登录统计
grep "Accepted password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c

# 3. 异常时间登录检测
grep "Accepted" /var/log/auth.log | awk '$3 ~ /^(2[2-3]|0[0-6]):/ {print}'

# 4. 用户扫描检测
grep "Invalid user" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr

# 5. 权限提升检测
grep "sudo:" /var/log/auth.log | grep -v "session opened"

# 6. 系统错误分析
grep -i "error\\|fail\\|denied" /var/log/syslog | tail -50

# 7. 网络连接日志
grep "Connection" /var/log/auth.log | tail -20
</div>

<h4>🚨 攻击特征识别</h4>
<ul>
<li><strong>暴力破解攻击</strong> - 短时间内大量失败登录尝试</li>
<li><strong>字典攻击</strong> - 尝试常见用户名如admin、test等</li>
<li><strong>分布式攻击</strong> - 来自多个IP的协调攻击</li>
<li><strong>慢速攻击</strong> - 低频率长时间的持续攻击</li>
<li><strong>成功入侵</strong> - 失败尝试后的成功登录</li>
</ul>

<h4>🔧 高级分析技巧</h4>
<ol>
<li><strong>时间窗口分析</strong> - 分析特定时间段的活动模式</li>
<li><strong>频率统计</strong> - 计算攻击频率和成功率</li>
<li><strong>地理位置分析</strong> - 结合IP地理位置信息</li>
<li><strong>用户行为画像</strong> - 建立正常用户行为基线</li>
<li><strong>威胁情报关联</strong> - 与已知威胁IP库进行比对</li>
</ol>

<h4>📊 日志分析最佳实践</h4>
<ul>
<li>建立日志收集和集中化管理机制</li>
<li>设置实时告警规则，及时发现异常</li>
<li>定期进行日志分析和安全审计</li>
<li>保留足够长的日志历史记录</li>
<li>使用专业的日志分析工具提高效率</li>
</ul>

<h4>⚠️ 分析注意事项</h4>
<ul>
<li>注意日志的完整性，防止被攻击者清除</li>
<li>结合多个日志源进行交叉验证</li>
<li>关注日志中的时间戳异常</li>
<li>保护日志文件的安全性和完整性</li>
</ul>
</div>
    `,
    
    network: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>🌐 网络安全检查与分析指南</h3>

<h4>📖 网络安全检查的重要性</h4>
<p>网络是攻击者进入系统和数据外泄的主要通道。通过网络检查可以发现后门连接、异常通信和潜在的数据泄露行为。</p>

<h4>🔍 网络检查的核心要点</h4>
<ol>
<li><strong>端口监听分析</strong> - 识别异常的监听服务</li>
<li><strong>连接状态检查</strong> - 分析活跃的网络连接</li>
<li><strong>流量模式分析</strong> - 发现异常的数据传输</li>
<li><strong>防火墙规则审计</strong> - 检查安全策略配置</li>
<li><strong>DNS解析检查</strong> - 发现恶意域名解析</li>
</ol>

<h4>💻 网络检查关键命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 查看监听端口和服务
ss -tulnp
netstat -tulnp

# 2. 查看活跃连接
ss -antp
netstat -antp

# 3. 检查网络接口配置
ip addr show
ifconfig -a

# 4. 查看路由表
ip route
route -n

# 5. 检查ARP表
arp -a
ip neigh

# 6. 查看防火墙规则
iptables -L -n
ufw status

# 7. 检查网络统计
ss -s
netstat -i

# 8. DNS配置检查
cat /etc/resolv.conf
cat /etc/hosts
</div>

<h4>🚨 可疑网络活动特征</h4>
<ul>
<li><strong>异常监听端口</strong> - 非标准端口上的监听服务</li>
<li><strong>外连可疑IP</strong> - 连接到恶意或未知IP地址</li>
<li><strong>大量并发连接</strong> - 异常高的连接数量</li>
<li><strong>非标准协议</strong> - 使用罕见端口或协议</li>
<li><strong>反向连接</strong> - 系统主动连接外部地址</li>
</ul>

<h4>🔧 网络分析技巧</h4>
<ol>
<li><strong>端口扫描检测</strong> - 识别端口扫描行为</li>
<li><strong>流量基线建立</strong> - 建立正常网络流量模式</li>
<li><strong>地理位置分析</strong> - 分析连接的地理分布</li>
<li><strong>协议分析</strong> - 深入分析网络协议使用</li>
<li><strong>时间模式分析</strong> - 分析网络活动的时间规律</li>
</ol>

<h4>🛡️ 网络安全防护建议</h4>
<ul>
<li>关闭不必要的网络服务和端口</li>
<li>配置防火墙规则限制网络访问</li>
<li>使用网络监控工具实时监控流量</li>
<li>定期检查和更新网络安全策略</li>
<li>实施网络分段和访问控制</li>
</ul>

<h4>⚠️ 检查注意事项</h4>
<ul>
<li>注意区分正常业务流量和异常流量</li>
<li>关注加密流量中的异常模式</li>
<li>监控DNS查询的异常模式</li>
<li>定期更新威胁情报和恶意IP列表</li>
</ul>
</div>
    `,
    
    process: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>⚙️ 进程安全检查与分析指南</h3>

<h4>📖 进程检查的重要性</h4>
<p>恶意进程是攻击者在系统中执行恶意活动的载体。通过进程分析可以发现后门程序、挖矿木马、数据窃取工具等恶意软件。</p>

<h4>🔍 进程检查的核心方法</h4>
<ol>
<li><strong>进程行为分析</strong> - 分析进程的运行行为和资源使用</li>
<li><strong>父子关系检查</strong> - 分析进程的启动来源</li>
<li><strong>网络连接关联</strong> - 检查进程的网络活动</li>
<li><strong>文件访问监控</strong> - 监控进程的文件操作</li>
<li><strong>权限等级审查</strong> - 检查进程的运行权限</li>
</ol>

<h4>💻 进程检查关键命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 查看所有进程详细信息
ps aux
ps -ef

# 2. 按CPU使用率排序
ps aux --sort=-%cpu | head -20

# 3. 按内存使用率排序
ps aux --sort=-%mem | head -20

# 4. 查看进程树结构
pstree -p
ps -ejH

# 5. 查看进程的网络连接
lsof -i
ss -tulnp

# 6. 查看进程打开的文件
lsof -p PID
ls -la /proc/PID/fd/

# 7. 检查可疑脚本进程
ps aux | grep -E 'bash|sh|python|perl|php|nc'

# 8. 查看系统启动的进程
systemctl list-units --type=service --state=running

# 9. 检查进程的启动时间
ps -eo pid,lstart,cmd
</div>

<h4>🚨 可疑进程特征</h4>
<ul>
<li><strong>高CPU使用率</strong> - 异常高的CPU占用（可能是挖矿程序）</li>
<li><strong>异常网络连接</strong> - 连接到可疑IP或端口</li>
<li><strong>隐藏进程名</strong> - 使用空格或特殊字符隐藏</li>
<li><strong>临时目录执行</strong> - 从/tmp、/var/tmp等目录运行</li>
<li><strong>无父进程</strong> - 孤儿进程或异常的父子关系</li>
</ul>

<h4>🔧 进程分析技巧</h4>
<ol>
<li><strong>资源使用分析</strong> - 监控CPU、内存、网络使用情况</li>
<li><strong>启动时间关联</strong> - 与入侵时间进行关联分析</li>
<li><strong>命令行参数检查</strong> - 分析进程的启动参数</li>
<li><strong>文件哈希校验</strong> - 对可疑程序进行哈希校验</li>
<li><strong>行为监控</strong> - 使用strace等工具监控系统调用</li>
</ol>

<h4>🛡️ 进程安全防护</h4>
<ul>
<li>定期检查运行进程的合法性</li>
<li>监控异常的资源使用情况</li>
<li>限制进程的执行权限</li>
<li>使用进程监控工具实时告警</li>
<li>定期更新和扫描恶意软件特征</li>
</ul>

<h4>⚠️ 分析注意事项</h4>
<ul>
<li>某些系统进程可能被恶意程序伪装</li>
<li>注意进程的数字签名和来源验证</li>
<li>关注进程的网络通信模式</li>
<li>避免直接终止可疑进程，先收集证据</li>
</ul>
</div>
    `,
    
    filesystem: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>📁 文件系统安全检查指南</h3>

<h4>📖 文件系统检查的重要性</h4>
<p>文件系统是攻击者植入后门、存储恶意文件和篡改系统配置的主要目标。通过文件系统检查可以发现恶意文件、权限异常和系统完整性问题。</p>

<h4>🔍 文件系统检查要点</h4>
<ol>
<li><strong>权限异常检查</strong> - 发现SUID/SGID等特殊权限文件</li>
<li><strong>文件完整性验证</strong> - 检查关键文件是否被篡改</li>
<li><strong>隐藏文件发现</strong> - 查找隐藏的恶意文件</li>
<li><strong>时间戳分析</strong> - 分析文件的修改时间</li>
<li><strong>文件类型识别</strong> - 识别伪装的恶意文件</li>
</ol>

<h4>💻 文件系统检查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 查找SUID文件
find / -perm -4000 -type f 2>/dev/null

# 2. 查找SGID文件
find / -perm -2000 -type f 2>/dev/null

# 3. 查找最近修改的文件
find / -mtime -7 -type f 2>/dev/null | grep -v proc

# 4. 查找隐藏文件
find / -name ".*" -type f 2>/dev/null | head -50

# 5. 查找大文件（可能的数据收集）
find / -size +100M -type f 2>/dev/null

# 6. 检查临时目录
ls -la /tmp /var/tmp /dev/shm

# 7. 查找可执行文件
find /tmp /var/tmp -type f -executable 2>/dev/null

# 8. 检查系统关键目录
ls -la /bin /sbin /usr/bin /usr/sbin

# 9. 查找最近访问的文件
find / -atime -1 -type f 2>/dev/null | head -20

# 10. 文件完整性检查
md5sum /bin/ls /bin/ps /bin/netstat
</div>

<h4>🚨 可疑文件特征</h4>
<ul>
<li><strong>异常SUID文件</strong> - 在临时目录或异常位置的SUID文件</li>
<li><strong>隐藏可执行文件</strong> - 以点开头的可执行文件</li>
<li><strong>系统文件篡改</strong> - 关键系统命令被替换</li>
<li><strong>异常大文件</strong> - 可能包含窃取的数据</li>
<li><strong>时间戳异常</strong> - 修改时间与入侵时间相关</li>
</ul>

<h4>🔧 文件分析技巧</h4>
<ol>
<li><strong>文件指纹对比</strong> - 与已知恶意文件哈希对比</li>
<li><strong>文件类型检测</strong> - 使用file命令检查真实类型</li>
<li><strong>字符串分析</strong> - 使用strings命令分析文件内容</li>
<li><strong>权限审计</strong> - 检查文件权限的合理性</li>
<li><strong>依赖关系分析</strong> - 分析文件的依赖和调用关系</li>
</ol>

<h4>🛡️ 文件系统安全建议</h4>
<ul>
<li>定期进行文件完整性检查</li>
<li>限制临时目录的执行权限</li>
<li>监控关键目录的文件变化</li>
<li>使用文件完整性监控工具</li>
<li>定期清理临时文件和日志</li>
</ul>

<h4>⚠️ 检查注意事项</h4>
<ul>
<li>避免在检查过程中执行可疑文件</li>
<li>对重要发现进行备份和取证</li>
<li>注意文件的软链接和硬链接关系</li>
<li>关注文件的数字签名和来源</li>
</ul>
</div>
    `,
    
    package: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>📦 软件包安全检查指南</h3>

<h4>📖 软件包检查的重要性</h4>
<p>恶意软件包可能包含后门、木马或其他恶意代码。通过软件包检查可以发现未授权安装的软件、可疑的包管理器活动和潜在的供应链攻击。</p>

<h4>🔍 软件包检查要点</h4>
<ol>
<li><strong>包完整性验证</strong> - 检查软件包的数字签名和校验和</li>
<li><strong>安装历史审计</strong> - 分析软件包的安装时间和来源</li>
<li><strong>依赖关系检查</strong> - 识别异常的依赖关系</li>
<li><strong>版本一致性</strong> - 检查软件包版本的合理性</li>
<li><strong>来源可信度</strong> - 验证软件包的来源仓库</li>
</ol>

<h4>💻 软件包检查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# Debian/Ubuntu系统
# 1. 查看已安装的软件包
dpkg -l
apt list --installed

# 2. 查看软件包安装历史
grep " install " /var/log/dpkg.log
grep " install " /var/log/apt/history.log

# 3. 检查软件包完整性
debsums -c
dpkg --verify

# 4. 查看软件包信息
dpkg -s package_name
apt show package_name

# RedHat/CentOS系统
# 1. 查看已安装的软件包
rpm -qa
yum list installed

# 2. 查看软件包安装历史
grep "Installed:" /var/log/yum.log
rpm -qa --last

# 3. 检查软件包完整性
rpm -Va
rpm --verify package_name

# 4. 查看软件包信息
rpm -qi package_name
yum info package_name

# 通用命令
# 查找最近安装的软件包
find /var/cache/apt/archives -name "*.deb" -mtime -7
find /var/cache/yum -name "*.rpm" -mtime -7
</div>

<h4>🚨 可疑软件包特征</h4>
<ul>
<li><strong>未知来源包</strong> - 来自非官方仓库的软件包</li>
<li><strong>签名异常</strong> - 缺少数字签名或签名验证失败</li>
<li><strong>版本异常</strong> - 版本号不符合正常规律</li>
<li><strong>安装时间可疑</strong> - 在入侵时间附近安装的软件包</li>
<li><strong>依赖异常</strong> - 包含异常依赖关系的软件包</li>
</ul>

<h4>🔧 软件包分析技巧</h4>
<ol>
<li><strong>时间线分析</strong> - 将安装时间与安全事件关联</li>
<li><strong>依赖树分析</strong> - 分析软件包的完整依赖关系</li>
<li><strong>文件清单检查</strong> - 检查软件包安装的文件列表</li>
<li><strong>仓库源验证</strong> - 验证软件包来源的可信度</li>
<li><strong>版本对比</strong> - 与官方版本进行对比</li>
</ol>

<h4>🛡️ 软件包安全建议</h4>
<ul>
<li>只从可信的官方仓库安装软件包</li>
<li>定期更新软件包到最新版本</li>
<li>启用软件包签名验证</li>
<li>监控软件包的安装和更新活动</li>
<li>定期进行软件包完整性检查</li>
</ul>

<h4>⚠️ 检查注意事项</h4>
<ul>
<li>注意区分正常的系统更新和恶意安装</li>
<li>关注第三方仓库的安全性</li>
<li>检查软件包的数字签名有效性</li>
<li>监控包管理器的配置文件变化</li>
</ul>
</div>
    `,
    
    persistence: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>🔄 持久化机制检查指南</h3>

<h4>📖 持久化检查的重要性</h4>
<p>攻击者为了维持对系统的长期访问，会建立各种持久化机制。这些机制确保即使系统重启或检测到入侵，攻击者仍能重新获得访问权限。</p>

<h4>🔍 持久化检查要点</h4>
<ol>
<li><strong>启动项检查</strong> - 检查系统和用户级别的启动项</li>
<li><strong>计划任务审计</strong> - 分析cron和systemd定时任务</li>
<li><strong>服务配置检查</strong> - 检查系统服务的配置</li>
<li><strong>SSH密钥审计</strong> - 检查SSH公钥认证配置</li>
<li><strong>环境变量检查</strong> - 检查可能被劫持的环境变量</li>
</ol>

<h4>💻 持久化检查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 检查系统服务
systemctl list-units --type=service
systemctl list-unit-files --type=service --state=enabled

# 2. 检查cron计划任务
crontab -l
ls -la /etc/cron*
cat /etc/crontab
ls -la /var/spool/cron/

# 3. 检查at计划任务
atq
ls -la /var/spool/at/

# 4. 检查SSH公钥
cat ~/.ssh/authorized_keys
find /home -name "authorized_keys" -exec ls -la {} \\;

# 5. 检查启动脚本
ls -la /etc/init.d/
ls -la /etc/rc*.d/
cat /etc/rc.local

# 6. 检查systemd用户服务
systemctl --user list-units --type=service
ls -la ~/.config/systemd/user/

# 7. 检查环境变量配置
cat /etc/environment
cat /etc/profile
cat ~/.bashrc ~/.profile

# 8. 检查内核模块
lsmod
ls -la /etc/modules-load.d/

# 9. 检查定时器
systemctl list-timers
</div>

<h4>🚨 可疑持久化特征</h4>
<ul>
<li><strong>异常启动服务</strong> - 未知或可疑的系统服务</li>
<li><strong>隐藏计划任务</strong> - 在非标准位置的cron任务</li>
<li><strong>未授权SSH密钥</strong> - 不明来源的公钥文件</li>
<li><strong>修改的启动脚本</strong> - 被篡改的系统启动脚本</li>
<li><strong>异常环境变量</strong> - 可疑的PATH或LD_PRELOAD设置</li>
</ul>

<h4>🔧 持久化分析技巧</h4>
<ol>
<li><strong>时间关联分析</strong> - 将配置修改时间与入侵时间关联</li>
<li><strong>权限检查</strong> - 检查配置文件的权限和所有者</li>
<li><strong>内容分析</strong> - 分析脚本和配置文件的内容</li>
<li><strong>依赖关系</strong> - 分析服务和任务的依赖关系</li>
<li><strong>网络连接</strong> - 检查持久化机制的网络活动</li>
</ol>

<h4>🛡️ 持久化防护建议</h4>
<ul>
<li>定期审计系统启动项和服务配置</li>
<li>监控计划任务的创建和修改</li>
<li>严格控制SSH密钥的管理</li>
<li>使用配置管理工具监控系统配置变化</li>
<li>实施最小权限原则</li>
</ul>

<h4>⚠️ 检查注意事项</h4>
<ul>
<li>某些持久化机制可能伪装成正常服务</li>
<li>注意检查用户级别的持久化配置</li>
<li>关注隐藏在正常配置中的恶意代码</li>
<li>检查配置文件的完整性和数字签名</li>
</ul>
</div>
    `,
    
    integrity: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>🛡️ 系统完整性检查指南</h3>

<h4>📖 系统完整性检查的重要性</h4>
<p>系统完整性检查是发现系统文件篡改、rootkit感染和高级持续威胁(APT)的关键手段。通过对比文件哈希值和系统基线，可以发现隐蔽的系统修改。</p>

<h4>🔍 完整性检查要点</h4>
<ol>
<li><strong>文件哈希验证</strong> - 对比关键文件的哈希值</li>
<li><strong>系统基线对比</strong> - 与已知良好状态进行对比</li>
<li><strong>数字签名验证</strong> - 检查文件的数字签名</li>
<li><strong>Rootkit检测</strong> - 使用专业工具检测rootkit</li>
<li><strong>内核完整性</strong> - 检查内核模块和系统调用</li>
</ol>

<h4>💻 完整性检查命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 关键系统文件哈希检查
md5sum /bin/ls /bin/ps /bin/netstat /usr/bin/top
sha256sum /bin/bash /bin/sh /usr/bin/ssh

# 2. 使用AIDE进行完整性检查
aide --init
aide --check

# 3. 使用Tripwire进行检查
tripwire --check

# 4. 检查系统文件权限
find /bin /sbin /usr/bin /usr/sbin -type f -exec ls -l {} \\;

# 5. 使用chkrootkit检测rootkit
chkrootkit

# 6. 使用rkhunter检测rootkit
rkhunter --check

# 7. 检查内核模块
lsmod
cat /proc/modules

# 8. 检查系统调用表
cat /proc/kallsyms | grep sys_call_table

# 9. 使用debsums检查Debian包完整性
debsums -c

# 10. 使用rpm验证RedHat包完整性
rpm -Va
</div>

<h4>🚨 完整性异常特征</h4>
<ul>
<li><strong>哈希值不匹配</strong> - 关键文件的哈希值发生变化</li>
<li><strong>文件大小异常</strong> - 系统文件大小与预期不符</li>
<li><strong>修改时间异常</strong> - 系统文件的修改时间可疑</li>
<li><strong>权限变化</strong> - 关键文件权限被异常修改</li>
<li><strong>数字签名失效</strong> - 文件的数字签名验证失败</li>
</ul>

<h4>🔧 完整性分析技巧</h4>
<ol>
<li><strong>基线建立</strong> - 在系统安装后立即建立完整性基线</li>
<li><strong>定期检查</strong> - 建立定期的完整性检查机制</li>
<li><strong>增量分析</strong> - 分析两次检查之间的变化</li>
<li><strong>白名单管理</strong> - 维护已知良好变化的白名单</li>
<li><strong>告警关联</strong> - 将完整性告警与其他安全事件关联</li>
</ol>

<h4>🛡️ 完整性保护建议</h4>
<ul>
<li>部署文件完整性监控系统(FIM)</li>
<li>定期更新完整性检查的基线</li>
<li>使用只读存储保护关键配置</li>
<li>实施代码签名和验证机制</li>
<li>建立完整性检查的自动化流程</li>
</ul>

<h4>⚠️ 检查注意事项</h4>
<ul>
<li>正常的系统更新也会改变文件哈希值</li>
<li>某些rootkit可能绕过常规检测工具</li>
<li>需要使用可信的外部工具进行检查</li>
<li>关注内核级别的完整性检查</li>
</ul>
</div>
    `,
    
    malware: `
<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 10px 0;">
<h3>🦠 恶意软件检测与分析指南</h3>

<h4>📖 恶意软件检测的重要性</h4>
<p>恶意软件是网络攻击的主要载体，包括病毒、木马、蠕虫、勒索软件、挖矿程序等。及时发现和分析恶意软件对于遏制攻击扩散和评估损失至关重要。</p>

<h4>🔍 恶意软件检测要点</h4>
<ol>
<li><strong>行为特征识别</strong> - 识别恶意软件的行为模式</li>
<li><strong>文件特征分析</strong> - 分析可疑文件的特征</li>
<li><strong>网络通信检测</strong> - 发现恶意的网络通信</li>
<li><strong>系统资源监控</strong> - 监控异常的资源使用</li>
<li><strong>持久化机制</strong> - 发现恶意软件的持久化手段</li>
</ol>

<h4>💻 恶意软件检测命令</h4>
<div style="background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 5px; font-family: monospace;">
# 1. 查找可疑进程
ps aux | grep -E 'bash|sh|python|perl|php' | grep -v grep
ps aux --sort=-%cpu | head -20

# 2. 检查网络连接
netstat -antp | grep ESTABLISHED
ss -antp | grep -v '127.0.0.1'

# 3. 查找隐藏文件
find / -name ".*" -type f 2>/dev/null | head -50
find /tmp /var/tmp -type f -executable 2>/dev/null

# 4. 检查异常大文件
find / -size +100M -type f 2>/dev/null

# 5. 查找最近修改的可执行文件
find / -type f -executable -mtime -7 2>/dev/null

# 6. 使用ClamAV扫描
clamscan -r /home /tmp /var/tmp

# 7. 检查进程的文件描述符
lsof -p PID

# 8. 查看系统调用
strace -p PID

# 9. 检查内存映射
cat /proc/PID/maps

# 10. 查找字符串特征
strings suspicious_file | grep -E 'http|ftp|password|key'
</div>

<h4>🚨 恶意软件特征</h4>
<ul>
<li><strong>异常CPU使用</strong> - 挖矿程序常表现为高CPU占用</li>
<li><strong>可疑网络连接</strong> - 连接到C&C服务器或恶意域名</li>
<li><strong>文件加密行为</strong> - 勒索软件的文件加密活动</li>
<li><strong>权限提升尝试</strong> - 尝试获取更高权限</li>
<li><strong>数据收集行为</strong> - 收集敏感信息和凭据</li>
</ul>

<h4>🔧 恶意软件分析技巧</h4>
<ol>
<li><strong>静态分析</strong> - 不执行文件的情况下分析其特征</li>
<li><strong>动态分析</strong> - 在隔离环境中观察运行行为</li>
<li><strong>网络流量分析</strong> - 分析恶意软件的网络通信</li>
<li><strong>内存分析</strong> - 分析内存中的恶意代码</li>
<li><strong>威胁情报关联</strong> - 与已知威胁情报进行关联</li>
</ol>

<h4>🛡️ 恶意软件防护建议</h4>
<ul>
<li>部署多层次的反恶意软件解决方案</li>
<li>定期更新恶意软件特征库</li>
<li>实施应用程序白名单机制</li>
<li>加强邮件和网络安全防护</li>
<li>建立恶意软件应急响应流程</li>
</ul>

<h4>⚠️ 分析注意事项</h4>
<ul>
<li>在隔离环境中进行恶意软件分析</li>
<li>避免直接执行可疑文件</li>
<li>注意恶意软件的反分析技术</li>
<li>及时更新检测工具和特征库</li>
</ul>
</div>
    `
  };
  
  return tutorials[category] || '<p>暂无教程内容</p>';
}

function openTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  const tablinks = document.getElementsByClassName("tablinks");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}

function findAllMatches(text, searchTerm) {
  if (!searchTerm) return [];
  const regex = new RegExp(searchTerm, 'gi');
  const matches = [];
  let match;
  while ((match = regex.exec(text)) !== null) {
    matches.push({
      index: match.index,
      text: match[0],
      position: matches.length,
      end: match.index + match[0].length
    });
  }
  return matches;
}

function searchTabs() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  if (!input) {
    updateSearchCount(0, -1);
    return;
  }

  searchResults = [];
  currentSearchIndex = -1;
  
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const tabId = tabs[i].id;
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      const preText = pres[j].textContent;
      const matches = findAllMatches(preText, input);
      matches.forEach(match => {
        searchResults.push({
          tabId,
          preIndex: j,
          ...match
        });
      });
    }
  }
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function updateSearchCount(total, current) {
  const countElement = document.getElementById("searchCount");
  if (total === 0) {
    countElement.textContent = "未找到匹配项";
    document.getElementById("prevMatch").disabled = true;
    document.getElementById("nextMatch").disabled = true;
  } else {
    countElement.textContent = `${current + 1}/${total}`;
    document.getElementById("prevMatch").disabled = current <= 0;
    document.getElementById("nextMatch").disabled = current >= total - 1;
  }
}

function navigateSearch(direction) {
  if (searchResults.length === 0) return;
  
  currentSearchIndex += direction;
  if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
  if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;
  
  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function highlightCurrentMatch() {
  // 清除所有高亮
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      let html = pres[j].innerHTML.replace(/<span class="mark.*?">(.*?)<\/span>/g, "$1");
      pres[j].innerHTML = html;
    }
  }
  
  if (searchResults.length === 0 || currentSearchIndex === -1) return;
  
  const currentMatch = searchResults[currentSearchIndex];
  
  // 切换到对应的标签页
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${currentMatch.tabId}')"]`);
  if (tabButton) {
    tabButton.click();
  }
  
  // 高亮所有匹配项，当前匹配项特殊高亮
  const searchTerm = document.getElementById("searchInput").value;
  const regex = new RegExp(`(${searchTerm})`, 'gi');
  const targetPre = document.getElementById(currentMatch.tabId)
    .getElementsByTagName("pre")[currentMatch.preIndex];
  
  targetPre.innerHTML = targetPre.textContent.replace(regex, (match, p1, offset) => {
    const isCurrentMatch = offset === currentMatch.index;
    return `<span class="mark${isCurrentMatch ? ' current' : ''}">${match}</span>`;
  });
  
  // 找到当前匹配项的元素
  const currentElement = targetPre.querySelector('.mark.current');
  if (currentElement) {
    // 获取父级details元素
    const detailsElement = targetPre.closest('details');
    if (detailsElement && !detailsElement.open) {
      detailsElement.open = true;
    }
    
    // 计算滚动位置
    const contentContainer = document.querySelector('.content-container');
    const elementRect = currentElement.getBoundingClientRect();
    const containerRect = contentContainer.getBoundingClientRect();
    
    // 检查元素是否在视图中
    const isInView = (
      elementRect.top >= containerRect.top &&
      elementRect.bottom <= containerRect.bottom
    );
    
    if (!isInView) {
      // 计算理想的滚动位置（将匹配项放在容器中间）
      const elementTop = elementRect.top + contentContainer.scrollTop - containerRect.top;
      const containerMiddle = containerRect.height / 2;
      const scrollTo = elementTop - containerMiddle + elementRect.height / 2;
      
      // 平滑滚动到目标位置
      contentContainer.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });
    }
    
    // 添加闪烁动画以突出显示当前匹配项
    currentElement.style.animation = 'none';
    currentElement.offsetHeight; // 触发重绘
    currentElement.style.animation = 'highlight-pulse 1s';
  }
}

// 添加规则引擎API调用
async function analyzeReport(data) {
  try {
    // 使用相对路径，自动适配当前域名和端口
    const response = await fetch('/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const results = await response.json();
    alertResults = results;
    displayAlerts();
  } catch (error) {
    console.error('规则分析失败:', error);
    // 如果API调用失败，使用本地分析
    performLocalAnalysis(data);
  }
}

// 本地分析功能（当API不可用时）
function performLocalAnalysis(data) {
  const localResults = {
    high: [],
    medium: [],
    low: []
  };
  
  // 检查UID为0的用户
  if (data.backdoor && data.backdoor['UID为0的非root用户']) {
    const uid0Content = data.backdoor['UID为0的非root用户'];
    if (uid0Content.includes('可疑UID 0用户') || uid0Content.match(/^(?!root)/m)) {
      localResults.high.push({
        rule_id: 'LOCAL_001',
        section: 'backdoor',
        subsection: 'UID为0的非root用户',
        description: '发现可疑的UID为0用户',
        severity: 'high',
        recommendation: '立即与运维和开发人员确认这些用户的合法性，如无法确认应立即禁用'
      });
    }
  }
  
  // 检查可疑进程
  if (data.process && data.process['可疑脚本进程']) {
    const processes = data.process['可疑脚本进程'].split('\n').filter(p => p.trim());
    if (processes.length > 10) {
      localResults.medium.push({
        rule_id: 'LOCAL_002',
        section: 'process',
        subsection: '可疑脚本进程',
        description: `发现${processes.length}个可疑脚本进程，数量异常`,
        severity: 'medium',
        recommendation: '检查这些进程的合法性，确认其业务必要性'
      });
    }
  }
  
  // 检查登录失败
  if (data.user && data.user['登录失败记录']) {
    const failedLogins = data.user['登录失败记录'];
    const failCount = (failedLogins.match(/Failed password/g) || []).length;
    if (failCount > 50) {
      localResults.medium.push({
        rule_id: 'LOCAL_003',
        section: 'user',
        subsection: '登录失败记录',
        description: `登录失败次数(${failCount})异常，可能存在暴力破解攻击`,
        severity: 'medium',
        recommendation: '检查登录日志，加强密码策略和访问控制'
      });
    }
  }
  
  alertResults = localResults;
  displayAlerts();
  
  // 显示本地分析提示
  const container = document.getElementById('alertContainer');
  const localNotice = document.createElement('div');
  localNotice.style.cssText = 'background: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px; color: #1565c0;';
  localNotice.innerHTML = '📍 当前使用本地分析模式，功能有限。建议启动完整的规则引擎服务获得更准确的分析结果。';
  container.insertBefore(localNotice, container.firstChild);
}

// 修改renderTabs函数
function renderTabs(data) {
  analysisData = data;
  
  // 生成统计总览数据
  const summaryData = generateSummaryContent(data);
  data.summary = summaryData;
  
  const tabBtnHtml = gTabs.map((k, i) => 
    `<button class="tablinks" onclick="openTab(event, '${k}')">${TAB_TITLES[k]}</button>`
  ).join("");
  document.getElementById("tabBtns").innerHTML = tabBtnHtml;

  const tabContentHtml = gTabs.map(k => {
    const subTitles = SUB_TAB_TITLES[k];
    const subContent = subTitles.map(title => {
      let content = "";
      if (title === '📚 排查教程') {
        // 显示教程内容
        content = generateTutorial(k);
        return `<details open><summary>${title}</summary><div style="padding: 10px;">${content}</div></details>`;
      } else {
        // 显示实际数据
        content = data[k] && data[k][title] ? data[k][title] : "";
        return `<details open><summary>${title}</summary><pre>${escapeHtml(content)}</pre></details>`;
      }
    }).join("");
    return `<div id="${k}" class="tabcontent">${subContent}</div>`;
  }).join("");
  document.getElementById("tabContents").innerHTML = tabContentHtml;

  // 显示统计面板
  displayStatsPanel();
  
  if (gTabs.length) {
    setTimeout(() => document.getElementsByClassName("tablinks")[0].click(), 100);
  }
  
  // 调用规则引擎API进行分析
  analyzeReport(data);
}

// 显示统计面板
function displayStatsPanel() {
  const stats = systemStats;
  const statsHtml = `
    <div class="stats-panel">
      <h3>📊 系统安全状况总览</h3>
      <div class="risk-level risk-${stats.risk_level.toLowerCase()}">
        风险等级: ${stats.risk_level} (评分: ${stats.risk_score})
      </div>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">${stats.total_users}</div>
          <div class="stat-label">总用户数</div>
        </div>
        <div class="stat-item">
          <div class="stat-number ${stats.uid0_users > 0 ? 'risk-high' : ''}">${stats.uid0_users}</div>
          <div class="stat-label">异常高权限用户</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.listening_ports}</div>
          <div class="stat-label">监听端口</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.suspicious_processes}</div>
          <div class="stat-label">可疑进程</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.suid_files}</div>
          <div class="stat-label">SUID文件</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">${stats.failed_logins}</div>
          <div class="stat-label">登录失败</div>
        </div>
      </div>
    </div>
  `;
  
  // 在内容区域顶部插入统计面板
  const contentContainer = document.querySelector('.content-container');
  const existingStats = contentContainer.querySelector('.stats-panel');
  if (existingStats) {
    existingStats.remove();
  }
  contentContainer.insertAdjacentHTML('afterbegin', statsHtml);
}

function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c]));
}

document.addEventListener("DOMContentLoaded", function() {
  document.getElementById("fileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const text = e.target.result;
        try {
          const data = JSON.parse(text);
          renderTabs(data);
        } catch (jsonError) {
          const data = parseTextReport(text);
          renderTabs(data);
        }
      } catch (err) {
        alert("解析失败：" + err.message);
      }
    };
    reader.readAsText(file);
  });
  
  // 添加搜索导航事件监听
  document.getElementById("prevMatch").addEventListener("click", () => navigateSearch(-1));
  document.getElementById("nextMatch").addEventListener("click", () => navigateSearch(1));
});

// 添加侧边栏折叠功能
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const button = document.querySelector('.collapse-button');
  if (sidebar.style.width === '0px') {
    sidebar.style.width = '350px';
    button.textContent = '收起告警面板 >';
  } else {
    sidebar.style.width = '0px';
    button.textContent = '< 展开告警面板';
  }
}

// 添加显示告警的函数
function displayAlerts() {
  const container = document.getElementById('alertContainer');
  const summary = document.getElementById('alertSummary');
  
  // 清空现有内容
  container.innerHTML = '';
  summary.innerHTML = '';
  
  // 显示告警统计
  const summaryHtml = `
    <div class="alert-badge high">
      <span>高危告警</span>
      <span class="count">${alertResults.high.length}</span>
    </div>
    <div class="alert-badge medium">
      <span>中危告警</span>
      <span class="count">${alertResults.medium.length}</span>
    </div>
    <div class="alert-badge low">
      <span>低危告警</span>
      <span class="count">${alertResults.low.length}</span>
    </div>
  `;
  summary.innerHTML = summaryHtml;
  
  // 显示告警详情
  const alertsHtml = [
    ...alertResults.high.map(alert => `
      <div class="alert alert-high">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            规则ID: ${alert.rule_id} | 模块: ${alert.section} | 子项: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>发现:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    位置: ${finding.start}-${finding.end}, 匹配文本: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>处置建议:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.medium.map(alert => `
      <div class="alert alert-medium">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            规则ID: ${alert.rule_id} | 模块: ${alert.section} | 子项: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>发现:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    位置: ${finding.start}-${finding.end}, 匹配文本: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>处置建议:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.low.map(alert => `
      <div class="alert alert-low">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            规则ID: ${alert.rule_id} | 模块: ${alert.section} | 子项: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>发现:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    位置: ${finding.start}-${finding.end}, 匹配文本: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
          ${alert.recommendation ? `
            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
              <strong>处置建议:</strong> ${alert.recommendation}
            </div>
          ` : ''}
        </div>
      </div>
    `)
  ].join('');
  
  container.innerHTML = alertsHtml;
}

function scrollToPosition(section, subsection, start, end) {
  // 切换到对应的标签页
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${section}')"]`);
  if (tabButton) {
    tabButton.click();
  }
  
  // 找到对应的详情元素并展开
  setTimeout(() => {
    const tabContent = document.getElementById(section);
    if (tabContent) {
      const details = Array.from(tabContent.querySelectorAll('details')).find(d => 
        d.querySelector('summary').textContent.includes(subsection)
      );
      if (details) {
        details.open = true;
        details.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }, 100);
}

</script>
</head>
<body>
  <div class="header">
    <h1>🛡️ Linux 应急响应报告查看器 (详细版)</h1>
    <div class="subtitle">专业化安全威胁检测与分析系统 | 详细日志分析 + 攻击溯源 + 技术教程</div>
  </div>

  <div class="main-container">
    <div class="content-container">
      <div class="search-container">
        <input type="file" id="fileInput" accept=".txt,.json">
        <input type="text" id="searchInput" placeholder="搜索报告内容..." onkeyup="searchTabs()">
        <div class="search-nav">
          <button id="prevMatch" onclick="navigateSearch(-1)" disabled>上一个</button>
          <button id="nextMatch" onclick="navigateSearch(1)" disabled>下一个</button>
          <span id="searchCount">输入关键词搜索</span>
        </div>
      </div>

      <div class="tabs" id="tabBtns">
        <!-- 标签按钮将在这里动态生成 -->
      </div>

      <div id="tabContents">
        <!-- 标签内容将在这里动态生成 -->
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">
        <h3>🚨 安全告警面板</h3>
        <button class="collapse-button" onclick="toggleSidebar()">收起告警面板 ></button>
        <div id="alertSummary" class="alert-summary">
          <!-- 告警统计将在这里显示 -->
        </div>
      </div>
      <div id="alertContainer" class="alert-container">
        <div style="text-align: center; padding: 40px; color: #666;">
          <p>📁 请选择报告文件开始分析</p>
          <p style="font-size: 0.9em; margin-top: 10px;">支持 .txt 和 .json 格式</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

